---
phase: 14-smart-component-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/selection/types.ts
  - src/services/selection/heuristics.ts
  - src/services/selection/index.ts
  - src/services/selection/heuristics.test.ts
autonomous: true

must_haves:
  truths:
    - "selectComponent returns appropriate component type for review arrays"
    - "selectComponent returns gallery for image-heavy arrays"
    - "selectComponent returns timeline for event-like arrays"
    - "selectComponent returns card-list or table based on content richness"
    - "All heuristics return null or result with confidence score"
    - "Only high-confidence results (>=0.75) trigger smart defaults"
  artifacts:
    - path: "src/services/selection/types.ts"
      provides: "ComponentSelection result type"
      exports: ["ComponentSelection"]
    - path: "src/services/selection/heuristics.ts"
      provides: "Pattern detection functions"
      exports: ["checkReviewPattern", "checkImageGalleryPattern", "checkTimelinePattern", "selectCardOrTable"]
    - path: "src/services/selection/index.ts"
      provides: "Public API for component selection"
      exports: ["selectComponent"]
    - path: "src/services/selection/heuristics.test.ts"
      provides: "Test coverage for all heuristics"
      min_lines: 200
  key_links:
    - from: "src/services/selection/heuristics.ts"
      to: "src/services/semantic/types.ts"
      via: "SemanticCategory import"
      pattern: "import.*SemanticCategory"
    - from: "src/services/selection/heuristics.ts"
      to: "src/services/analysis/types.ts"
      via: "ImportanceScore import"
      pattern: "import.*ImportanceScore"
    - from: "src/services/selection/index.ts"
      to: "src/services/selection/heuristics.ts"
      via: "heuristic function imports"
      pattern: "import.*heuristics"
---

<objective>
Create the smart component selection service with pattern detection heuristics

Purpose: Enable context-aware component selection based on semantic analysis from Phase 12 and importance tiers from Phase 13. This is the core decision engine that determines whether arrays render as cards, tables, galleries, or timelines.

Output: A selection service in src/services/selection/ with public selectComponent() API and comprehensive tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-smart-component-selection/14-CONTEXT.md
@.planning/phases/14-smart-component-selection/14-RESEARCH.md
@src/services/semantic/types.ts
@src/services/semantic/index.ts
@src/services/analysis/types.ts
@src/services/analysis/index.ts
@src/types/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selection service types and heuristics</name>
  <files>
    src/services/selection/types.ts
    src/services/selection/heuristics.ts
    src/services/selection/index.ts
  </files>
  <action>
Create the selection service module with strategy pattern for component selection.

**src/services/selection/types.ts:**
```typescript
export interface ComponentSelection {
  componentType: string  // 'table' | 'card-list' | 'gallery' | 'timeline' | etc.
  confidence: number     // 0.0 - 1.0
  reason: string         // e.g., 'review-pattern-detected', 'image-heavy-content'
}

export interface SelectionContext {
  semantics: Map<string, import('@/types/schema').SemanticMetadata>
  importance: Map<string, import('@/services/analysis/types').ImportanceScore>
}
```

**src/services/selection/heuristics.ts:**

Implement 4 heuristic functions following the patterns from RESEARCH.md:

1. `checkReviewPattern(schema, context)` - Detects rating + comment/review fields
   - Returns card-list with 0.85 confidence when both rating and review/description fields present
   - Review/description must be primary or secondary tier
   - User decision: Star ratings as default display

2. `checkImageGalleryPattern(schema, context)` - Detects image-heavy arrays
   - Returns gallery with 0.9 confidence when image fields present AND <=4 total fields
   - Returns card-list with 0.75 confidence when images mixed with >4 other fields
   - User decision: Fixed-column grid layout

3. `checkTimelinePattern(schema, context)` - Detects event-like arrays
   - Returns timeline with 0.8 confidence when date/timestamp + title/description present
   - User decision: Requires event-like semantics (NOT just chronological ordering)
   - Must have date field AND title OR description field

4. `selectCardOrTable(schema, context)` - Default card vs table heuristic
   - Count primary + secondary tier fields (ignore tertiary for field count)
   - User decision: Content richness trumps field count
   - Returns card-list with 0.75 confidence when rich content AND <=8 visible fields
   - Returns table with 0.8 confidence when >=10 visible fields
   - Returns table with 0.5 confidence for ambiguous cases

Rich content categories: description, reviews, image, title

Helper function `getArrayItemFields(schema)` to extract field info from array of objects schema.

**src/services/selection/index.ts:**

Public API:
```typescript
export function selectComponent(
  schema: TypeSignature,
  context: SelectionContext
): ComponentSelection {
  // Only apply smart selection for arrays of objects
  if (schema.kind !== 'array' || schema.items.kind !== 'object') {
    return { componentType: getDefaultTypeName(schema), confidence: 0, reason: 'not-applicable' }
  }

  // Try heuristics in priority order
  const heuristics = [
    checkReviewPattern,
    checkImageGalleryPattern,
    checkTimelinePattern,
    selectCardOrTable,
  ]

  for (const heuristic of heuristics) {
    const result = heuristic(schema, context)
    if (result && result.confidence >= 0.75) {
      return result
    }
  }

  // Fallback to type-based default
  return { componentType: 'table', confidence: 0, reason: 'fallback-to-default' }
}

// Re-export getDefaultTypeName for use by DynamicRenderer
export function getDefaultTypeName(schema: TypeSignature): string {
  if (schema.kind === 'array' && schema.items.kind === 'object') return 'table'
  if (schema.kind === 'array' && schema.items.kind === 'primitive') return 'primitive-list'
  if (schema.kind === 'object') return 'detail'
  if (schema.kind === 'primitive') return 'primitive'
  return 'json'
}
```

Import from existing modules:
- TypeSignature from @/types/schema
- SemanticMetadata from @/types/schema
- ImportanceScore from @/services/analysis/types
  </action>
  <verify>
    npx tsc --noEmit src/services/selection/index.ts
    # Should compile without errors
  </verify>
  <done>
    - selectComponent function exported and callable
    - All 4 heuristic functions implemented
    - Types properly defined and exported
    - No TypeScript compilation errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive heuristics tests</name>
  <files>
    src/services/selection/heuristics.test.ts
  </files>
  <action>
Create comprehensive tests for all selection heuristics.

Test categories (aim for 30+ test cases):

**1. Review Pattern Detection (6 tests)**
- Returns card-list when rating + comment fields present
- Returns card-list when rating + review fields present
- Returns card-list when rating + description (primary/secondary tier) present
- Returns null when only rating field (no comment)
- Returns null when rating field absent
- Confidence is 0.85 for review pattern

**2. Image Gallery Pattern Detection (6 tests)**
- Returns gallery when image fields present AND <=4 total fields
- Returns card-list when image + >4 other fields
- Returns null when no image fields
- Handles thumbnail and avatar semantic categories
- Confidence is 0.9 for pure gallery, 0.75 for mixed
- Gallery for array of pure image URLs (single field)

**3. Timeline Pattern Detection (5 tests)**
- Returns timeline when date + title present
- Returns timeline when timestamp + description present
- Returns null when only date field (no title/description)
- Returns null when only title (no date)
- Confidence is 0.8 for event pattern

**4. Card vs Table Heuristic (8 tests)**
- Returns card-list for <=8 visible fields with rich content
- Returns table for >=10 visible fields
- Returns table with 0.5 for ambiguous (8-10 fields, no rich content)
- Rich content detection: description, reviews, image, title
- Counts only primary + secondary tier fields (ignores tertiary)
- Content richness trumps field count (12 fields but 8 tertiary = cards)
- Table confidence is 0.8 for high field count
- Card confidence is 0.75 for rich content

**5. selectComponent Integration (6 tests)**
- Priority order: review > gallery > timeline > card-vs-table
- Falls back to type-based default for non-array schemas
- Falls back to table with confidence 0 when no heuristic matches at 0.75
- Returns 'primitive-list' for array of primitives
- Returns 'detail' for object schema
- Returns 'json' for unknown schema kinds

**6. Edge Cases (3 tests)**
- Empty field list returns table fallback
- Schema with missing items property handled gracefully
- Context with empty maps handled gracefully

Create mock helper functions:
- `createMockSchema(fields)` - Build ArraySchema with object items
- `createMockContext(semantics, importance)` - Build SelectionContext
- `createMockField(name, semantic, tier)` - Create field with semantic and tier
  </action>
  <verify>
    npm test src/services/selection/heuristics.test.ts
    # All tests should pass (expect 30+ tests)
  </verify>
  <done>
    - All test categories covered (review, image, timeline, card-vs-table, integration, edge cases)
    - At least 30 test cases
    - All tests passing
    - Tests verify confidence thresholds (0.75, 0.8, 0.85, 0.9)
    - Tests verify reason strings match expected values
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compilation: `npx tsc --noEmit`
2. Tests pass: `npm test src/services/selection/`
3. Manual verification:
```bash
npx tsx -e "
import { selectComponent } from './src/services/selection';
import type { TypeSignature } from './src/types/schema';

// Mock review array schema
const reviewSchema: TypeSignature = {
  kind: 'array',
  items: {
    kind: 'object',
    fields: new Map([
      ['rating', { kind: 'primitive', type: 'number' }],
      ['comment', { kind: 'primitive', type: 'string' }],
      ['author', { kind: 'primitive', type: 'string' }],
    ])
  }
};

const context = {
  semantics: new Map([['$[].rating', { category: 'rating', confidence: 0.9 }]]),
  importance: new Map([
    ['$[].comment', { tier: 'primary', score: 0.85, signals: [] }],
    ['$[].author', { tier: 'secondary', score: 0.6, signals: [] }],
  ])
};

const result = selectComponent(reviewSchema, context);
console.log(JSON.stringify(result, null, 2));
"
# Should output: { componentType: 'card-list', confidence: 0.85, reason: 'review-pattern-detected' }
```
</verification>

<success_criteria>
- Selection service compiles without TypeScript errors
- All 30+ tests pass
- selectComponent returns appropriate component types for:
  - Review arrays (rating + comment) -> card-list
  - Image arrays (<=4 fields) -> gallery
  - Image arrays (>4 fields) -> card-list
  - Event arrays (date + title/description) -> timeline
  - Rich content arrays (<=8 fields) -> card-list
  - Large field arrays (10+ fields) -> table
- Confidence threshold of 0.75 enforced
- Fallback to type-based defaults when no heuristic matches
</success_criteria>

<output>
After completion, create `.planning/phases/14-smart-component-selection/14-01-SUMMARY.md`
</output>
