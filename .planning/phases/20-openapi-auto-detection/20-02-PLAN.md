---
phase: 20-openapi-auto-detection
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/components/auth/AuthPanel.tsx
  - src/components/auth/AuthTypeSelector.tsx
  - src/components/auth/CredentialForm.tsx
  - src/components/URLInput.tsx
  - src/hooks/useAPIFetch.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "When loading an OpenAPI spec with securitySchemes, the auth panel shows detected auth requirements"
    - "Detected auth type is pre-selected in AuthTypeSelector dropdown"
    - "Detected metadata pre-populates CredentialForm fields (header name, param name)"
    - "Unsupported schemes (OAuth 2.0, OpenID Connect) display a visible warning message"
    - "Auth panel auto-expands when spec has security schemes detected"
    - "User can still manually override the pre-selected auth type"
    - "Specs without security schemes show no auth-related changes (no regression)"
  artifacts:
    - path: "src/components/auth/AuthPanel.tsx"
      provides: "AuthPanel accepts detectedAuth prop, pre-populates type and shows warnings"
      contains: "detectedAuth"
    - path: "src/components/auth/AuthTypeSelector.tsx"
      provides: "AuthTypeSelector accepts defaultType for pre-selection"
    - path: "src/components/auth/CredentialForm.tsx"
      provides: "CredentialForm accepts metadata for pre-populating field values"
      contains: "defaultHeaderName|defaultParamName"
    - path: "src/hooks/useAPIFetch.ts"
      provides: "Spec fetch flow passes detected auth from parsedSpec"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/URLInput.tsx"
      via: "passes parsedSpec.securitySchemes as detectedAuth prop"
      pattern: "detectedAuth.*securitySchemes"
    - from: "src/components/URLInput.tsx"
      to: "src/components/auth/AuthPanel.tsx"
      via: "forwards detectedAuth prop"
      pattern: "detectedAuth"
    - from: "src/components/auth/AuthPanel.tsx"
      to: "src/components/auth/AuthTypeSelector.tsx"
      via: "pre-selects type from detectedAuth.supported[0]"
      pattern: "detectedAuth"
    - from: "src/components/auth/AuthPanel.tsx"
      to: "src/components/auth/CredentialForm.tsx"
      via: "passes metadata (headerName, paramName) from detected scheme"
      pattern: "metadata|headerName|paramName"
---

<objective>
Wire detected OpenAPI security schemes into the auth panel UI for pre-population and unsupported scheme warnings.

Purpose: When a user loads an OpenAPI spec that declares security schemes, the auth panel should automatically detect the auth type, pre-populate metadata fields (like header names or query param names), and warn about unsupported schemes (OAuth 2.0, OpenID Connect). This closes the loop from spec parsing to user-facing auth configuration.

Output: Updated AuthPanel, AuthTypeSelector, CredentialForm, URLInput, and App.tsx to thread detected auth from ParsedSpec through to the UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-openapi-auto-detection/20-RESEARCH.md
@.planning/phases/20-openapi-auto-detection/20-01-SUMMARY.md

@src/services/openapi/types.ts
@src/components/auth/AuthPanel.tsx
@src/components/auth/AuthTypeSelector.tsx
@src/components/auth/CredentialForm.tsx
@src/components/URLInput.tsx
@src/App.tsx
@src/store/appStore.ts
@src/types/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread detected auth from parsedSpec to AuthPanel</name>
  <files>
    src/App.tsx
    src/components/URLInput.tsx
    src/components/auth/AuthPanel.tsx
  </files>
  <action>
    1. In App.tsx: Extract `parsedSpec.securitySchemes` and pass it to URLInput as a new prop `detectedAuth`. Import `ParsedSecurityScheme` from `src/services/openapi/types`. Add to URLInputProps: `detectedAuth?: ParsedSecurityScheme[]`. Pass `detectedAuth={parsedSpec?.securitySchemes}` to both URLInput instances (sidebar layout and non-sidebar layout).

    2. In URLInput.tsx: Accept `detectedAuth` prop (type: `ParsedSecurityScheme[]` imported from services/openapi/types). Forward to AuthPanel as `detectedAuth={detectedAuth}`. Auto-expand auth panel when detectedAuth has at least one supported scheme (any item where authType !== null): add a useEffect that calls `setAuthPanelOpen(true)` when detectedAuth changes and has supported schemes. Do NOT auto-expand if detectedAuth only contains unsupported schemes.

    3. In AuthPanel.tsx: Accept new prop `detectedAuth?: ParsedSecurityScheme[]`. Import ParsedSecurityScheme from services/openapi/types. Separate supported schemes (authType !== null) from unsupported (authType === null).

    For pre-population: When detectedAuth changes and has supported schemes, and the user has NOT already configured credentials for this API (apiCreds is null or activeType is null), auto-select the first supported scheme's authType. Use a useEffect that runs when detectedAuth changes: if no existing credentials, call handleTypeChange with the first supported scheme's authType.

    For unsupported warning: When there are unsupported schemes, render a warning box ABOVE the AuthTypeSelector. Use a yellow/amber background (bg-amber-50 border border-amber-200 rounded-md p-3). Display text like "This API requires authentication methods not yet supported:" followed by a list of unsupported scheme names and their reasons (from the unsupported items). Use the AlertTriangle icon from lucide-react.

    Pass metadata from the currently matched detected scheme to CredentialForm. Find the detected scheme matching the selectedType: `const matchedScheme = detectedAuth?.find(s => s.authType === selectedType)`. Pass matchedScheme?.metadata as a new prop `detectedMetadata` to CredentialForm.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Run `npx vite build` -- builds without errors.
  </verify>
  <done>
    - parsedSpec.securitySchemes flows from App.tsx through URLInput to AuthPanel
    - Auth panel auto-expands when spec has supported security schemes
    - Unsupported schemes display amber warning with scheme names and reasons
    - First supported scheme auto-selects in AuthTypeSelector when no existing credentials
  </done>
</task>

<task type="auto">
  <name>Task 2: Pre-populate credential form fields from detected metadata</name>
  <files>
    src/components/auth/CredentialForm.tsx
    src/components/auth/AuthTypeSelector.tsx
  </files>
  <action>
    1. In CredentialForm.tsx: Add optional prop `detectedMetadata?: { headerName?: string; paramName?: string }`. When detectedMetadata is provided and the user has NOT already entered custom values (i.e., the current store credential for this type is null or has default values):

    - For apiKey type: If detectedMetadata.headerName exists, use it as the initial headerName state value instead of the default 'X-API-Key'. Update the useEffect that loads existing credentials (the one watching `type` and `url`): in the `else` block (no existing credential), check detectedMetadata.headerName and call setHeaderName with that value. Also update the placeholder text on the header name input to show the detected name.

    - For queryParam type: If detectedMetadata.paramName exists, use it as the initial paramName state value instead of 'api_key'. Same pattern as above -- in the useEffect else block, set paramName from detectedMetadata. Update the placeholder on the param name input.

    - For bearer and basic types: No metadata changes needed (these types have no metadata to pre-populate).

    IMPORTANT: The pre-populated values should NOT auto-save to the auth store. They should only pre-fill the form fields. The user still needs to enter the actual secret value (API key, token, password) before credentials get saved. This is because the CredentialForm's onChange handlers call saveCredential, and we don't want empty credentials saved just from metadata.

    2. In AuthTypeSelector.tsx: No functional changes needed. The parent AuthPanel already controls the `value` prop, so pre-selection from detectedAuth flows naturally through the existing value/onChange pattern. However, add a subtle visual hint when the type was auto-detected: accept an optional `detectedType` prop (AuthType | undefined). When the selected value matches detectedType, show a small "(detected)" label next to the selected option text. Implement by adding a small span after the select element: `{detectedType && value === detectedType && <span className="text-xs text-blue-500 ml-2">Detected from spec</span>}`.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Run `npx vite build` -- builds without errors.
    Run `npx vitest run` -- full test suite passes.
  </verify>
  <done>
    - CredentialForm pre-fills headerName from detected metadata (e.g., "X-API-Key" from spec instead of default)
    - CredentialForm pre-fills paramName from detected metadata (e.g., "api_key" from spec)
    - Pre-populated metadata does NOT auto-save empty credentials to store
    - AuthTypeSelector shows "Detected from spec" hint when type matches detected
    - All existing tests pass, build succeeds
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript errors
2. `npx vite build` -- successful production build
3. `npx vitest run` -- all tests pass
4. Manual smoke test: Load Pet Store OpenAPI spec (https://petstore.swagger.io/v2/swagger.json) -- this spec has api_key (apiKey in header) and petstore_auth (OAuth 2.0). Expected behavior:
   - Auth panel auto-expands
   - AuthTypeSelector pre-selects "API Key" (first supported scheme)
   - Header name field pre-populates with "api_key" (from spec)
   - Amber warning shows: "OAuth 2.0 requires browser-based authorization flow" for petstore_auth
   - User can still change auth type manually
</verification>

<success_criteria>
- SPEC-03 satisfied: Auth panel pre-populates type and metadata from spec
- SPEC-04 satisfied: Unsupported schemes show warning instead of crashing
- No regression: Specs without security schemes and direct API URLs work identically to before
- No auto-save: Pre-populated metadata only fills form fields, doesn't create empty credentials
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-openapi-auto-detection/20-02-SUMMARY.md`
</output>
