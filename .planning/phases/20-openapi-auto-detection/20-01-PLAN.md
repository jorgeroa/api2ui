---
phase: 20-openapi-auto-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/openapi/types.ts
  - src/services/openapi/security-mapper.ts
  - src/services/openapi/parser.ts
  - src/services/openapi/__tests__/security-mapper.test.ts
  - src/services/openapi/__tests__/parser.test.ts
autonomous: true

must_haves:
  truths:
    - "parseOpenAPISpec returns securitySchemes array for OpenAPI 3.x specs with components.securitySchemes"
    - "parseOpenAPISpec returns securitySchemes array for Swagger 2.0 specs with securityDefinitions"
    - "apiKey with in:header maps to authType 'apiKey' with headerName metadata"
    - "apiKey with in:query maps to authType 'queryParam' with paramName metadata"
    - "http scheme:bearer maps to authType 'bearer'"
    - "http scheme:basic maps to authType 'basic'"
    - "Swagger 2.0 type:basic maps to authType 'basic'"
    - "oauth2 and openIdConnect map to authType null with unsupported reason"
    - "apiKey with in:cookie maps to authType null (unsupported)"
    - "Specs without security schemes return empty securitySchemes array"
  artifacts:
    - path: "src/services/openapi/types.ts"
      provides: "ParsedSecurityScheme interface and extended ParsedSpec"
      contains: "ParsedSecurityScheme"
    - path: "src/services/openapi/security-mapper.ts"
      provides: "mapSecuritySchemes pure function"
      exports: ["mapSecuritySchemes"]
    - path: "src/services/openapi/__tests__/security-mapper.test.ts"
      provides: "Unit tests for security scheme mapping"
      min_lines: 80
    - path: "src/services/openapi/__tests__/parser.test.ts"
      provides: "Extended parser tests with securitySchemes extraction"
  key_links:
    - from: "src/services/openapi/parser.ts"
      to: "src/services/openapi/security-mapper.ts"
      via: "import and call mapSecuritySchemes"
      pattern: "mapSecuritySchemes"
    - from: "src/services/openapi/parser.ts"
      to: "src/services/openapi/types.ts"
      via: "ParsedSecurityScheme type in ParsedSpec.securitySchemes"
      pattern: "securitySchemes.*ParsedSecurityScheme"
---

<objective>
TDD: Extract and map OpenAPI security schemes to api2ui auth types.

Purpose: Enable the parser to detect authentication requirements from OpenAPI specs so the UI can pre-populate auth configuration. This is the data layer -- pure functions with well-defined inputs and outputs.

Output: Extended ParsedSpec with securitySchemes array, security-mapper.ts with mapSecuritySchemes function, comprehensive tests covering all scheme types and edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-openapi-auto-detection/20-RESEARCH.md

@src/services/openapi/types.ts
@src/services/openapi/parser.ts
@src/services/openapi/__tests__/parser.test.ts
@src/types/auth.ts
</context>

<feature>
  <name>Security scheme extraction and mapping</name>
  <files>
    src/services/openapi/types.ts
    src/services/openapi/security-mapper.ts
    src/services/openapi/parser.ts
    src/services/openapi/__tests__/security-mapper.test.ts
    src/services/openapi/__tests__/parser.test.ts
  </files>
  <behavior>
    The mapping function converts OpenAPI security scheme objects to api2ui auth type suggestions:

    OpenAPI 3.x inputs -> expected outputs:
    - { type: 'apiKey', in: 'header', name: 'X-API-Key' } -> { authType: 'apiKey', metadata: { headerName: 'X-API-Key' } }
    - { type: 'apiKey', in: 'query', name: 'api_key' } -> { authType: 'queryParam', metadata: { paramName: 'api_key' } }
    - { type: 'apiKey', in: 'cookie', name: 'session' } -> { authType: null } (unsupported, reason: "Cookie-based authentication is not supported")
    - { type: 'http', scheme: 'bearer' } -> { authType: 'bearer', metadata: {} }
    - { type: 'http', scheme: 'bearer', bearerFormat: 'JWT' } -> { authType: 'bearer', metadata: {} } (bearerFormat ignored)
    - { type: 'http', scheme: 'basic' } -> { authType: 'basic', metadata: {} }
    - { type: 'oauth2', flows: {...} } -> { authType: null } (unsupported, reason: "OAuth 2.0 requires browser-based authorization flow")
    - { type: 'openIdConnect', openIdConnectUrl: '...' } -> { authType: null } (unsupported, reason: "OpenID Connect requires browser-based authorization flow")

    Swagger 2.0 inputs -> expected outputs:
    - { type: 'apiKey', in: 'header', name: 'X-API-Key' } -> { authType: 'apiKey', metadata: { headerName: 'X-API-Key' } }
    - { type: 'apiKey', in: 'query', name: 'api_key' } -> { authType: 'queryParam', metadata: { paramName: 'api_key' } }
    - { type: 'basic' } -> { authType: 'basic', metadata: {} } (Swagger 2.0 uses type:basic directly, no scheme field)
    - { type: 'oauth2', flow: 'implicit' } -> { authType: null } (unsupported)

    Parser integration:
    - parseOpenAPISpec() returns ParsedSpec with securitySchemes: ParsedSecurityScheme[]
    - OpenAPI 3.x: extracts from api.components.securitySchemes
    - Swagger 2.0: extracts from api.securityDefinitions
    - Specs without security schemes: securitySchemes is []
    - Each ParsedSecurityScheme has: name (string), authType (AuthType | null), metadata ({ headerName?, paramName? }), description (string | undefined)
  </behavior>
  <implementation>
    Step 1 - Types (src/services/openapi/types.ts):
    Add ParsedSecurityScheme interface with fields: name, authType (import AuthType from ../../types/auth), metadata ({ headerName?: string, paramName?: string }), description (optional string).
    Extend ParsedSpec interface with: securitySchemes: ParsedSecurityScheme[]

    Step 2 - Mapper (src/services/openapi/security-mapper.ts):
    Create mapSecuritySchemes function that accepts a Record of scheme name to OpenAPI security scheme objects (OpenAPIV3.SecuritySchemeObject or OpenAPIV2.SecuritySchemeObject) and returns ParsedSecurityScheme[].
    For each scheme entry:
    - Check type === 'apiKey': if in === 'header' -> authType: 'apiKey', metadata: { headerName: scheme.name }. If in === 'query' -> authType: 'queryParam', metadata: { paramName: scheme.name }. If in === 'cookie' -> authType: null.
    - Check type === 'http': if scheme.scheme === 'bearer' -> authType: 'bearer'. If scheme.scheme === 'basic' -> authType: 'basic'. Otherwise null.
    - Check type === 'basic' (Swagger 2.0 only): authType: 'basic'.
    - Check type === 'oauth2': authType: null.
    - Check type === 'openIdConnect': authType: null.
    Use scheme description if available, otherwise generate descriptive label from scheme name.

    Step 3 - Parser extension (src/services/openapi/parser.ts):
    Add extractSecuritySchemes helper that reads components.securitySchemes (OpenAPI 3.x) or securityDefinitions (Swagger 2.0).
    Call mapSecuritySchemes on the extracted schemes.
    Add securitySchemes to the returned ParsedSpec object.
    Import mapSecuritySchemes from ./security-mapper.

    Step 4 - Test extension (src/services/openapi/__tests__/parser.test.ts):
    Add securitySchemes to existing OpenAPI 3.x fixture (components.securitySchemes with ApiKeyAuth, BearerAuth, BasicAuth entries).
    Add securityDefinitions to existing Swagger 2.0 fixture (api_key, basic_auth entries).
    Add test: "extracts security schemes from OpenAPI 3.x spec" - verify securitySchemes array length and mapped types.
    Add test: "extracts security definitions from Swagger 2.0 spec" - verify basic auth maps correctly (type: basic, no scheme field).
    Add test: "returns empty securitySchemes for specs without security" - verify empty array (existing emptySpecFixture).
    Update existing test expectations to include securitySchemes field where ParsedSpec is checked.
  </implementation>
</feature>

<verification>
1. Run `npx vitest run src/services/openapi/__tests__/security-mapper.test.ts` -- all tests pass
2. Run `npx vitest run src/services/openapi/__tests__/parser.test.ts` -- all tests pass (including new security scheme tests)
3. Run `npx vitest run` -- full test suite passes with no regressions
4. Run `npx tsc --noEmit` -- no TypeScript errors
</verification>

<success_criteria>
- mapSecuritySchemes correctly maps all 4 supported auth types (apiKey header, apiKey query, http bearer, http basic)
- mapSecuritySchemes correctly identifies unsupported types (oauth2, openIdConnect, apiKey cookie)
- Swagger 2.0 basic auth (type: 'basic' without scheme field) maps correctly
- parseOpenAPISpec returns securitySchemes on ParsedSpec for both OpenAPI 3.x and Swagger 2.0
- All existing parser tests still pass unchanged (backward compatible)
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/20-openapi-auto-detection/20-01-SUMMARY.md`
</output>
