---
phase: 15-smart-grouping-visual-hierarchy
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/renderers/DetailRenderer.tsx
  - src/components/renderers/DetailRendererGrouped.tsx
autonomous: false

must_haves:
  truths:
    - "Detail views with >8 fields and detected groups render as Hero + Overview + Accordion Sections layout"
    - "Primary fields render large/bold in overview, secondary render normal, tertiary render small/muted"
    - "Accordion sections use Headless UI Disclosure with chevron rotation and collapse/expand"
    - "Show all (ungrouped) toggle switches to flat view, Show grouped toggles back"
    - "Grouping only applies when analysis cache has groups AND total fields >8"
    - "Maximum two-level grouping: hero/overview at top, accordion sections below (no nested accordions)"
    - "Detail views with fewer fields or no groups render the existing flat layout unchanged"
  artifacts:
    - path: "src/components/renderers/DetailRendererGrouped.tsx"
      provides: "Grouped detail view with accordions, hero layout, escape hatch"
      min_lines: 100
    - path: "src/components/renderers/DetailRenderer.tsx"
      provides: "Updated detail renderer with conditional grouped/ungrouped modes"
  key_links:
    - from: "src/components/renderers/DetailRenderer.tsx"
      to: "src/store/appStore.ts"
      via: "reads grouping from getAnalysisCache"
      pattern: "getAnalysisCache.*grouping"
    - from: "src/components/renderers/DetailRendererGrouped.tsx"
      to: "src/components/renderers/FieldRow.tsx"
      via: "uses FieldRow for consistent tier-based rendering"
      pattern: "FieldRow"
    - from: "src/components/renderers/DetailRendererGrouped.tsx"
      to: "@headlessui/react"
      via: "Disclosure for accordion sections"
      pattern: "Disclosure.*DisclosureButton.*DisclosurePanel"
---

<objective>
Implement the grouped detail view with Hero + Overview + Sections layout, accordion-based grouping, and "show all (ungrouped)" escape hatch.

Purpose: This is the primary user-facing deliverable of Phase 15. Detail views with many fields will now organize into visual sections: hero image at top, primary/secondary fields in overview, grouped fields in collapsible accordion sections, and ungrouped tertiary fields below. Users can toggle to flat ungrouped view at any time.

Output: DetailRendererGrouped component with accordion sections, updated DetailRenderer with conditional grouped/ungrouped rendering
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/15-smart-grouping-visual-hierarchy/15-01-SUMMARY.md
@src/components/renderers/DetailRenderer.tsx
@src/components/renderers/FieldRow.tsx
@src/store/appStore.ts
@src/services/analysis/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DetailRendererGrouped component with Hero + Overview + Sections layout</name>
  <files>src/components/renderers/DetailRendererGrouped.tsx</files>
  <action>
  Create `src/components/renderers/DetailRendererGrouped.tsx` implementing the grouped detail view.

  **Props:**
  ```typescript
  interface DetailRendererGroupedProps {
    data: Record<string, unknown>
    schema: TypeSignature  // kind === 'object'
    path: string
    depth: number
    heroImage: { url: string; fieldName: string } | null
    groups: FieldGroup[]
    ungroupedFields: FieldInfo[]
    importance: Map<string, ImportanceScore>
    fieldConfigs: Record<string, any>
    onContextMenu: (e: React.MouseEvent, fieldPath: string, fieldName: string, value: unknown) => void
    onToggleGrouping: () => void  // switches to ungrouped mode
  }
  ```

  **Layout structure (Hero + Overview + Sections):**

  1. **Hero Image** (conditional): Full-width hero image at top if detected
  2. **Overview section**: Primary + secondary fields rendered using FieldRow in a two-column grid (`grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4`). These are fields NOT in any group that have primary or secondary tier.
  3. **Accordion Sections**: Each group rendered as a collapsible Disclosure section:
     - Use `Disclosure` from `@headlessui/react` with `defaultOpen={true}` for first section, rest default open too (research says at least one should be open)
     - DisclosureButton: flex row with group label + chevron icon (rotate-180 on open via `ui-open:rotate-180`)
     - DisclosurePanel: fields rendered using FieldRow with their tier
     - Section header style: `px-4 py-3 text-left text-sm font-medium text-gray-900 bg-gray-50 hover:bg-gray-100 rounded-lg`
     - Section content: `px-4 py-3 space-y-2`
  4. **Ungrouped tertiary fields**: Any remaining ungrouped fields rendered below accordions with tertiary styling
  5. **Nested fields**: Objects/arrays rendered using DynamicRenderer (same as current DetailRenderer pattern)

  **Toggle button**: Render "Show all (ungrouped)" button at top-right of the view:
  - Style: `flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors`
  - Uses a simple list icon (inline SVG)
  - Calls `onToggleGrouping` on click

  **Two-level maximum enforced:** Groups contain fields only. No nested accordions within accordion panels. Nested objects/arrays within fields use DynamicRenderer which handles its own rendering.

  **Field rendering approach:**
  - Categorize ALL visible fields from schema.fields into: grouped (match group.fields by path), ungrouped-overview (primary/secondary not in groups), ungrouped-tertiary (tertiary not in groups)
  - For each category, look up importance tier from the importance Map using field path (`${path}.${fieldName}`)
  - Default to 'secondary' tier if no importance data available
  - Use FieldRow for primitive fields, existing image/nested rendering for complex fields

  **Image fields within groups:** If a field in a group is an image URL, render it as an image (same as current DetailRenderer pattern), not as a FieldRow.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify types compile. Check that Disclosure, DisclosureButton, DisclosurePanel are imported from @headlessui/react.
  </verify>
  <done>DetailRendererGrouped component renders Hero + Overview + Accordion Sections layout. Each group is a Disclosure accordion with chevron. Ungrouped fields render above (primary/secondary) and below (tertiary) the accordions. Toggle button present for switching to ungrouped view.</done>
</task>

<task type="auto">
  <name>Task 2: Wire DetailRenderer to conditionally use grouped view when beneficial</name>
  <files>src/components/renderers/DetailRenderer.tsx</files>
  <action>
  Update `DetailRenderer` to conditionally render `DetailRendererGrouped` when grouping is beneficial.

  **Changes to DetailRenderer.tsx:**

  1. **Import additions:**
     - Import `useAppStore` from `../../store/appStore`
     - Import `DetailRendererGrouped` from `./DetailRendererGrouped`
     - Import `FieldRow` from `./FieldRow`
     - Import `normalizePath` helper (copy from DynamicRenderer or create inline: `path.replace(/\[\d+\]/g, '[]')`)

  2. **Add state for grouped/ungrouped toggle:**
     ```typescript
     const [showGrouped, setShowGrouped] = useState(true)
     ```

  3. **Read analysis cache for grouping data (in view mode only):**
     ```typescript
     const { getAnalysisCache } = useAppStore()
     const cached = getAnalysisCache(path) || getAnalysisCache(path.replace(/\[\d+\]/g, '[]'))
     const grouping = cached?.grouping ?? null
     const importance = cached?.importance ?? new Map()
     ```

  4. **Determine if grouped view should apply:**
     ```typescript
     const shouldGroup = !isConfigureMode &&
       showGrouped &&
       grouping !== null &&
       grouping.groups.length > 0 &&
       visibleFields.length > 8
     ```

  5. **Conditional rendering (after the hero image detection and field categorization block):**
     If `shouldGroup` is true, render `DetailRendererGrouped` passing all required props:
     - data={obj}, schema, path, depth
     - heroImage, groups={grouping.groups}, ungroupedFields={grouping.ungrouped}
     - importance, fieldConfigs
     - onContextMenu={handleFieldContextMenu}
     - onToggleGrouping={() => setShowGrouped(false)}
     - Also render the popoverElement below it

     If `shouldGroup` is false, render the EXISTING view mode layout (current code, unchanged).

  6. **Update existing flat view to use FieldRow with tier styling:**
     In the existing flat (ungrouped) view mode rendering, replace the hardcoded `isPrimaryField` logic with importance-tier lookup:
     - For each primitive field, look up `importance.get(\`${path}.${fieldName}\`)?.tier ?? 'secondary'`
     - Pass tier to FieldRow instead of using the old `isPrimaryField()` function
     - Keep `isPrimaryField()` as a fallback when no importance data is available (tier = isPrimaryField(fieldName) ? 'primary' : 'secondary')

  7. **When toggled to ungrouped from grouped, show a "Show grouped" button:**
     If `grouping?.groups.length > 0 && !showGrouped && visibleFields.length > 8 && !isConfigureMode`, render a toggle button at the top that says "Show grouped" and calls `setShowGrouped(true)`.

  **Critical: Do NOT break configure mode.** The configure mode rendering path (SortableFieldList) should be completely unaffected. All grouped view logic is gated behind `!isConfigureMode`.

  **Critical: Do NOT break existing view mode for < 8 fields.** When shouldGroup is false, the existing rendering code runs unchanged.
  </action>
  <verify>
  1. Run `npx tsc --noEmit` - no type errors
  2. Run `npm test -- --run` - all tests pass
  3. Run `npm run build` - build succeeds
  </verify>
  <done>DetailRenderer conditionally renders grouped view when analysis cache has groups AND >8 fields. Flat view uses FieldRow with importance tiers. Toggle switches between grouped and ungrouped. Configure mode unchanged. Views with <8 fields render as before.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Smart grouping and visual hierarchy for detail views:
  - Three-tier visual hierarchy (primary fields large/bold, secondary normal, tertiary small/muted)
  - Accordion-based grouping with collapsible sections using Headless UI Disclosure
  - Hero + Overview + Sections layout pattern
  - "Show all (ungrouped)" / "Show grouped" toggle
  </what-built>
  <how-to-verify>
  1. Run `npm run dev` and open the app in browser
  2. Test with a complex API that has many fields. Good test URLs:
     - `https://jsonplaceholder.typicode.com/users/1` (10 fields including address and company nested objects - may trigger grouped view)
     - `https://dummyjson.com/products/1` (many fields with nested data)
  3. Verify visual hierarchy:
     - Primary fields (name, title) should be larger and bolder
     - Secondary fields should be normal size
     - Tertiary/metadata fields (id, timestamps) should be smaller and muted
  4. For APIs with >8 fields and detected groups:
     - Verify accordion sections appear with collapsible headers
     - Click a section header to collapse/expand - check chevron rotates
     - Verify "Show all (ungrouped)" toggle button is visible
     - Click the toggle to switch to flat view - verify all fields show ungrouped
     - Click "Show grouped" to switch back
  5. For APIs with few fields (< 8):
     - Verify the layout looks the same as before (no grouping UI appears)
  6. Verify configure mode still works (drag-and-drop field reordering, visibility toggles)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npm test -- --run` passes all existing tests
3. `npm run build` succeeds
4. Detail views with >8 fields and groups show accordion sections with collapsible headers
5. Primary fields visually larger/bolder than secondary, tertiary fields smaller/muted
6. "Show all (ungrouped)" toggle switches to flat view; "Show grouped" toggles back
7. Hero image still renders at top when present
8. Configure mode completely unaffected
9. Detail views with <8 fields render identically to before
10. No nested accordions within accordion panels (two-level max)
</verification>

<success_criteria>
- Detail views organize into Hero + Overview + Accordion Sections when grouping is beneficial
- Three-tier visual hierarchy is visually distinct for primary/secondary/tertiary
- Escape hatch toggle provides user control over grouping
- Existing behavior preserved for configure mode and simple views
</success_criteria>

<output>
After completion, create `.planning/phases/15-smart-grouping-visual-hierarchy/15-02-SUMMARY.md`
</output>
