---
phase: 21-smart-error-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/auth/AuthErrorDisplay.tsx
  - src/components/auth/AuthPanel.tsx
  - src/components/URLInput.tsx
autonomous: true

must_haves:
  truths:
    - "401 response shows inline prompt with 'Configure Authentication' action button"
    - "403 response shows distinct message with permission guidance, no action button"
    - "Clicking 'Configure Authentication' button opens the auth panel"
    - "No auto-retry occurs after auth errors — user must manually re-fetch"
  artifacts:
    - path: "src/components/auth/AuthErrorDisplay.tsx"
      provides: "Inline action button for 401, permission guidance for 403"
      contains: "onConfigureClick"
    - path: "src/components/auth/AuthPanel.tsx"
      provides: "Callback passthrough from parent to AuthErrorDisplay"
      contains: "onConfigureClick"
    - path: "src/components/URLInput.tsx"
      provides: "Panel expansion callback wired to AuthPanel"
      contains: "onConfigureClick"
  key_links:
    - from: "src/components/auth/AuthErrorDisplay.tsx"
      to: "src/components/auth/AuthPanel.tsx"
      via: "onConfigureClick prop"
      pattern: "onConfigureClick"
    - from: "src/components/auth/AuthPanel.tsx"
      to: "src/components/URLInput.tsx"
      via: "onConfigureClick prop passed through"
      pattern: "onConfigureClick.*setAuthPanelOpen"
---

<objective>
Enhance auth error UX so 401/403 errors guide users to fix issues with contextual prompts and actionable recovery buttons.

Purpose: Transform passive auth error text into actionable recovery moments — 401 errors get a "Configure Authentication" button that opens the auth panel, 403 errors get distinct permission guidance text. Completes ERR-01, ERR-02, ERR-03 requirements.

Output: Enhanced AuthErrorDisplay with inline action button, callback threading through AuthPanel and URLInput.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/auth/AuthErrorDisplay.tsx
@src/components/auth/AuthPanel.tsx
@src/components/URLInput.tsx
@src/components/ui/button.tsx
@.planning/phases/21-smart-error-ux/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance AuthErrorDisplay with action button and improved messaging</name>
  <files>src/components/auth/AuthErrorDisplay.tsx</files>
  <action>
    Rewrite AuthErrorDisplay to add an inline action button for 401 errors and enhanced messaging for both 401 and 403.

    Changes to AuthErrorDisplayProps interface:
    - Add `onConfigureClick?: () => void` optional callback prop

    Changes to the component body:
    - Wrap message text in a `div.flex-1.space-y-2` container (replacing the current `div.text-sm`)
    - Change 401 message to: "This API requires authentication. Configure now?"
    - Change 403 message to: "Credentials valid but insufficient permissions."
    - For 401: Add a shadcn Button (variant="outline", size="sm") below the message text with text "Configure Authentication" that calls onConfigureClick. Only render button if onConfigureClick is provided.
    - For 403: Add a `p.text-xs.opacity-80` paragraph below the message: "Contact your API provider to request elevated permissions for this endpoint."
    - Import Button from '@/components/ui/button'

    Keep existing color scheme (red for 401, orange for 403). Keep AlertCircle icon.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `grep -n "onConfigureClick" src/components/auth/AuthErrorDisplay.tsx` — confirm prop declared in interface and used in component.
    Run `grep -n "Button" src/components/auth/AuthErrorDisplay.tsx` — confirm Button import and JSX usage for 401 action.
    Run `grep -n "Configure now" src/components/auth/AuthErrorDisplay.tsx` — confirm 401 message text matches ERR-01 requirement.
    Run `grep -n "insufficient permissions" src/components/auth/AuthErrorDisplay.tsx` — confirm 403 message text matches ERR-02 requirement.
  </verify>
  <done>
    AuthErrorDisplay shows actionable "Configure Authentication" button for 401 errors and distinct permission guidance for 403 errors. Button calls onConfigureClick callback when clicked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Thread onConfigureClick callback through AuthPanel and URLInput</name>
  <files>src/components/auth/AuthPanel.tsx, src/components/URLInput.tsx</files>
  <action>
    Wire the onConfigureClick callback from URLInput through AuthPanel to AuthErrorDisplay so clicking "Configure Authentication" expands the auth panel.

    AuthPanel.tsx changes:
    - Add `onConfigureClick?: () => void` to AuthPanelProps interface
    - Destructure onConfigureClick in component params
    - Pass onConfigureClick to the AuthErrorDisplay component on line 71. Change `<AuthErrorDisplay error={authError} />` to `<AuthErrorDisplay error={authError} onConfigureClick={onConfigureClick} />`

    URLInput.tsx changes:
    - Pass `onConfigureClick={() => setAuthPanelOpen(true)}` as a new prop on the AuthPanel component (around line 156-162)

    The callback chain: URLInput.setAuthPanelOpen(true) -> AuthPanel.onConfigureClick -> AuthErrorDisplay.onConfigureClick -> Button onClick.

    Note: The auth panel already auto-expands on authError (useEffect on line 74-78). The button callback provides an explicit user action path when the panel is already open but the user scrolls past, or for when auto-expansion is insufficient context. The button is supplementary to auto-expansion, not a replacement.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run build` — builds cleanly.
    Run `grep -n "onConfigureClick" src/components/auth/AuthPanel.tsx` — confirm prop in interface, destructured, and passed to AuthErrorDisplay.
    Run `grep -n "onConfigureClick" src/components/URLInput.tsx` — confirm callback wired to setAuthPanelOpen(true).
    Run `npm run dev` and test manually:
    1. To trigger a 401: use the auth store to clear any credentials (`useAuthStore.getState().clearForApi(url)`), then fetch a protected API endpoint (e.g., https://api.github.com/user). Verify error message shows "This API requires authentication. Configure now?" with "Configure Authentication" button.
    2. Click "Configure Authentication" button — auth panel should be open/remain open.
    3. For 403: this is harder to trigger naturally (requires valid credentials with limited scope). Visual verification of component code is sufficient — confirm AuthErrorDisplay renders "Credentials valid but insufficient permissions." with "Contact your API provider..." guidance text for the 403 branch.
    4. Verify no auto-retry occurs — user must click Fetch to retry.
  </verify>
  <done>
    Clicking "Configure Authentication" button opens auth panel. 401 and 403 errors show distinct messages with appropriate actions. No auto-retry on auth failures.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. 401 response renders: red error box with "This API requires authentication. Configure now?" + "Configure Authentication" button
4. 403 response renders: orange error box with "Credentials valid but insufficient permissions." + "Contact your API provider..." text
5. Clicking "Configure Authentication" button expands/keeps auth panel open
6. No auto-retry on auth failures — fetchAndInfer only called on explicit Fetch button click or example card click
</verification>

<success_criteria>
- ERR-01 complete: 401/403 trigger inline prompt with actionable recovery
- ERR-02 complete: Clear distinction between 401 (add credentials) and 403 (insufficient permissions)
- ERR-03 complete: No auto-retry on auth failures (confirmed existing behavior, no changes needed)
- All TypeScript types pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-smart-error-ux/21-01-SUMMARY.md`
</output>
