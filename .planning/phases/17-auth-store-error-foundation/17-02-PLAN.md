---
phase: 17-auth-store-error-foundation
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/store/authStore.ts
  - src/components/error/ErrorDisplay.tsx
autonomous: true

must_haves:
  truths:
    - "Zustand auth store persists credentials to sessionStorage (cleared on tab close)"
    - "Credentials are scoped per API by origin (new URL(url).origin)"
    - "Store supports all 4 auth types with one active per API"
    - "Same-type credentials replace each other; different types coexist"
    - "clearForApi and clearAll remove credentials as expected"
    - "getActiveCredential returns the active credential for an origin (or null)"
    - "ErrorDisplay renders auth errors with appropriate styling"
  artifacts:
    - path: "src/store/authStore.ts"
      provides: "Zustand auth store with sessionStorage persistence"
      exports: ["useAuthStore"]
    - path: "src/components/error/ErrorDisplay.tsx"
      provides: "Auth error display configuration"
      contains: "auth:"
  key_links:
    - from: "src/store/authStore.ts"
      to: "src/types/auth.ts"
      via: "imports Credential, AuthType, AuthStatus, ApiCredentials types"
      pattern: "from.*types/auth"
    - from: "src/store/authStore.ts"
      to: "sessionStorage"
      via: "Zustand persist middleware with createJSONStorage(() => sessionStorage)"
      pattern: "createJSONStorage.*sessionStorage"
    - from: "src/components/error/ErrorDisplay.tsx"
      to: "src/types/errors.ts"
      via: "errorConfig object includes 'auth' kind"
      pattern: "auth:"
---

<objective>
Create the Zustand auth store with sessionStorage persistence and update ErrorDisplay to handle auth errors.

Purpose: Provide the credential storage API that Phase 18 (fetch integration) and Phase 19 (auth UI) consume.
Output: `src/store/authStore.ts` with full CRUD + query API, updated `ErrorDisplay.tsx` with auth error styling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-auth-store-error-foundation/17-CONTEXT.md
@.planning/phases/17-auth-store-error-foundation/17-RESEARCH.md
@.planning/phases/17-auth-store-error-foundation/17-01-SUMMARY.md
@src/store/configStore.ts
@src/store/parameterStore.ts
@src/types/auth.ts
@src/components/error/ErrorDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth store with sessionStorage persistence</name>
  <files>src/store/authStore.ts</files>
  <action>
Create `src/store/authStore.ts` following the exact Zustand persist pattern from `configStore.ts` and `parameterStore.ts`. Import types from `src/types/auth.ts`.

**State shape:**
```
credentials: Record<string, ApiCredentials>  // keyed by origin
authStatus: Record<string, AuthStatus>       // keyed by origin
```

**Helper function (module-level, not exported):**
- `getOrigin(url: string): string` â€” extracts origin via `new URL(url).origin`, falls back to raw url on parse error

**Actions (all take url: string and internally call getOrigin):**

1. `setCredential(url: string, credential: Credential)`:
   - Get origin from url
   - Get or create ApiCredentials for that origin
   - Set `credentials[credential.type] = credential` (same-type replaces)
   - Set `activeType = credential.type` (newly added credential becomes active)
   - Reset authStatus for this origin to 'untested'

2. `setActiveType(url: string, type: AuthType)`:
   - Set activeType for this origin (silent update, no side effects)
   - Only set if a credential of that type exists, otherwise no-op

3. `getActiveCredential(url: string): Credential | null`:
   - Get ApiCredentials for origin
   - Return the credential matching activeType, or null

4. `getCredentials(url: string): ApiCredentials | null`:
   - Return full ApiCredentials for origin, or null

5. `clearForApi(url: string)`:
   - Remove credentials entry for origin
   - Remove authStatus entry for origin

6. `clearAll()`:
   - Reset credentials to {} and authStatus to {}

7. `setAuthStatus(url: string, status: AuthStatus)`:
   - Set authStatus for origin

8. `getAuthStatus(url: string): AuthStatus`:
   - Return authStatus for origin, default 'untested'

9. `getConfiguredOrigins(): string[]`:
   - Return Object.keys(credentials)

**Persist config:**
- `name: 'api2ui-auth'`
- `version: 1`
- `storage: createJSONStorage(() => sessionStorage)` â€” NOT localStorage
- `partialize`: only persist `credentials` (NOT authStatus â€” that's runtime state)

Export `useAuthStore` as named export (matching project convention).
  </action>
  <verify>Run `npx tsc --noEmit` â€” no type errors. Verify sessionStorage usage: `grep "sessionStorage" src/store/authStore.ts` returns a match.</verify>
  <done>Auth store created with all 9 actions, sessionStorage persistence, origin-based scoping, correct partialize (credentials only)</done>
</task>

<task type="auto">
  <name>Task 2: Add auth error configuration to ErrorDisplay</name>
  <files>src/components/error/ErrorDisplay.tsx</files>
  <action>
In `src/components/error/ErrorDisplay.tsx`, add an `auth` entry to the `errorConfig` object to handle AuthError display. Place it between the `api` and `parse` entries:

```
auth: {
  title: 'Authentication Error',
  icon: 'ðŸ”’',
  bgColor: 'bg-purple-50',
  borderColor: 'border-purple-300',
  textColor: 'text-purple-800',
  iconBg: 'bg-purple-100',
},
```

This is the ONLY change to ErrorDisplay.tsx. Do NOT modify any other logic â€” the existing `isAppError` check and `kind` lookup already handles any AppError, so AuthError will be caught automatically since it implements AppError with `kind: 'auth'`.

Purple styling chosen to visually distinguish auth errors from API errors (yellow) and network errors (orange).
  </action>
  <verify>Run `npx tsc --noEmit` â€” no type errors. Verify the auth config exists: `grep "auth:" src/components/error/ErrorDisplay.tsx` returns a match.</verify>
  <done>ErrorDisplay shows auth errors with purple styling, existing error types unchanged</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/store/authStore.ts` exports `useAuthStore`
3. `grep "sessionStorage" src/store/authStore.ts` confirms sessionStorage (not localStorage)
4. `grep "partialize" src/store/authStore.ts` confirms only credentials persisted
5. `src/components/error/ErrorDisplay.tsx` has auth entry in errorConfig
6. `npm run build` succeeds (full build verification)
</verification>

<success_criteria>
- Auth store provides full CRUD API for credentials scoped by origin
- sessionStorage used (not localStorage) â€” credentials cleared on tab close
- Only credentials persisted, not authStatus (runtime-only)
- ErrorDisplay handles auth errors with distinct purple styling
- All existing functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/17-auth-store-error-foundation/17-02-SUMMARY.md`
</output>
