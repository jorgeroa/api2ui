---
phase: 09-url-parsing-type-inference
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/urlParser/types.ts
  - src/services/urlParser/parser.ts
  - src/services/urlParser/parser.test.ts
autonomous: true

must_haves:
  truths:
    - "Any URL with query params can be parsed into ParsedParameter[] format"
    - "Array params work in bracket notation (tag[]=x&tag[]=y)"
    - "Array params work in repeated key notation (tag=x&tag=y)"
    - "Parameter groups are extracted from bracket prefixes (ddcFilter[name] -> ddcFilter group)"
    - "Parse warnings are captured for encoding fixes and duplicate non-array values"
  artifacts:
    - path: "src/services/urlParser/types.ts"
      provides: "UrlParseResult, ParsedUrlParameter types"
      exports: ["UrlParseResult", "ParsedUrlParameter"]
    - path: "src/services/urlParser/parser.ts"
      provides: "URL parsing with array and group detection"
      exports: ["parseUrlParameters"]
    - path: "src/services/urlParser/parser.test.ts"
      provides: "Test coverage for all parsing scenarios"
      min_lines: 80
  key_links:
    - from: "src/services/urlParser/parser.ts"
      to: "ParsedParameter from openapi/types"
      via: "extends ParsedParameter with inferredType"
      pattern: "import.*ParsedParameter.*from.*openapi/types"
---

<objective>
Create URL query string parser that handles array notation and extracts parameter groups.

Purpose: Foundation for parsing any URL into editable form fields (not just OpenAPI specs). This enables users to paste arbitrary URLs and see their query parameters as a smart form.

Output: parseUrlParameters() function that converts URLs to ParsedParameter[] with group information and warnings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-url-parsing-type-inference/09-RESEARCH.md

# Existing type to extend
@src/services/openapi/types.ts
</context>

<feature>
  <name>URL Parameter Parser</name>
  <files>
    src/services/urlParser/types.ts
    src/services/urlParser/parser.ts
    src/services/urlParser/parser.test.ts
  </files>
  <behavior>
    Parse URL query strings into unified ParsedParameter[] format.

    **Input cases:**
    - Simple params: `?foo=bar&baz=123` -> [{name: "foo", value: "bar"}, {name: "baz", value: "123"}]
    - Bracket arrays: `?tag[]=a&tag[]=b` -> [{name: "tag", values: ["a", "b"], isArray: true}]
    - Repeated key arrays: `?tag=a&tag=b` -> [{name: "tag", values: ["a", "b"], isArray: true}]
    - Grouped params: `?ddcFilter[name]=foo&ddcFilter[age]=25` -> groups: {"ddcFilter": ["ddcFilter[name]", "ddcFilter[age]"]}
    - Empty values: `?foo=` -> [{name: "foo", value: ""}] (not hidden)
    - Encoding issues: `?foo=hello%20world` -> value: "hello world", warning if malformed encoding fixed

    **Edge cases:**
    - Duplicate non-array values: `?foo=1&foo=2` (no brackets) -> show both with warning about ambiguity
    - Mixed bracket/non-bracket: `?tag[]=a&tag=b` -> treat as array, warn about inconsistency
    - Invalid URL: -> return empty params with error in warnings

    **Output format:**
    ```typescript
    interface UrlParseResult {
      parameters: ParsedUrlParameter[]
      groups: Map<string, string[]>  // groupName -> paramNames
      warnings: string[]
    }
    ```
  </behavior>
  <implementation>
    1. Use native URLSearchParams for base parsing
    2. Post-process to normalize bracket notation (tag[] -> tag)
    3. Use getAll() to detect arrays (multiple values for same normalized key)
    4. Extract group prefixes via regex: /^([a-zA-Z_][a-zA-Z0-9_]*)\[/
    5. Track warnings for encoding fixes, duplicate non-arrays, parse failures
    6. Return ParsedUrlParameter[] extending ParsedParameter with additional fields for URL-specific data
  </implementation>
</feature>

<verification>
```bash
npm test -- src/services/urlParser/parser.test.ts
```

All tests must pass covering:
- Simple key=value parsing
- Bracket notation arrays
- Repeated key arrays
- Group extraction
- Empty values
- Encoding handling
- Invalid URL handling
- Duplicate non-array warnings
</verification>

<success_criteria>
- parseUrlParameters() handles all input cases from behavior spec
- Tests cover happy path and edge cases
- Groups correctly extracted from bracket prefixes
- Warnings capture encoding fixes and ambiguous duplicates
- Output format matches UrlParseResult interface
</success_criteria>

<output>
After completion, create `.planning/phases/09-url-parsing-type-inference/09-01-SUMMARY.md`
</output>
