---
phase: 12-core-semantic-detection
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/services/semantic/patterns/commerce.ts
  - src/services/semantic/patterns/identity.ts
  - src/services/semantic/patterns/media.ts
  - src/services/semantic/patterns/engagement.ts
  - src/services/semantic/patterns/index.ts
  - src/services/semantic/detector.ts
  - src/services/semantic/index.ts
autonomous: true

must_haves:
  truths:
    - "20-25 semantic patterns defined across 4 categories"
    - "Each pattern has multilingual name patterns (en, es, fr, de)"
    - "detectSemantics function returns sorted ConfidenceResult array"
    - "Composite patterns detect array structures (e.g., reviews)"
  artifacts:
    - path: "src/services/semantic/patterns/commerce.ts"
      provides: "Commerce patterns"
      exports: ["pricePattern", "currencyCodePattern", "skuPattern", "quantityPattern"]
    - path: "src/services/semantic/patterns/identity.ts"
      provides: "Identity patterns"
      exports: ["emailPattern", "phonePattern", "uuidPattern", "namePattern", "addressPattern", "urlPattern"]
    - path: "src/services/semantic/patterns/media.ts"
      provides: "Media patterns"
      exports: ["imagePattern", "videoPattern", "thumbnailPattern", "avatarPattern"]
    - path: "src/services/semantic/patterns/engagement.ts"
      provides: "Engagement patterns"
      exports: ["ratingPattern", "reviewsPattern", "tagsPattern", "statusPattern"]
    - path: "src/services/semantic/patterns/index.ts"
      provides: "Pattern registry"
      exports: ["getAllPatterns", "getPattern"]
    - path: "src/services/semantic/detector.ts"
      provides: "Detection engine"
      exports: ["detectSemantics", "detectCompositeSemantics"]
    - path: "src/services/semantic/index.ts"
      provides: "Public exports"
      min_lines: 10
  key_links:
    - from: "src/services/semantic/detector.ts"
      to: "src/services/semantic/patterns/index.ts"
      via: "getAllPatterns import"
      pattern: "import.*getAllPatterns"
    - from: "src/services/semantic/detector.ts"
      to: "src/services/semantic/scorer.ts"
      via: "calculateConfidence import"
      pattern: "import.*calculateConfidence"
---

<objective>
Build the pattern library and detection engine for semantic field classification.

Purpose: Define 20-25 semantic patterns with multilingual support and implement the main detection algorithm that Phase 13+ will use.
Output: Complete pattern library and working detectSemantics function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-core-semantic-detection/12-01-SUMMARY.md
@.planning/phases/12-core-semantic-detection/12-CONTEXT.md
@.planning/phases/12-core-semantic-detection/12-RESEARCH.md
@src/services/semantic/types.ts
@src/services/semantic/scorer.ts
@src/utils/primitiveDetection.ts
@src/utils/imageDetection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all pattern definitions</name>
  <files>
    src/services/semantic/patterns/commerce.ts
    src/services/semantic/patterns/identity.ts
    src/services/semantic/patterns/media.ts
    src/services/semantic/patterns/engagement.ts
    src/services/semantic/patterns/index.ts
  </files>
  <action>
Create pattern files following the SemanticPattern interface from types.ts.

**commerce.ts** - 4 patterns:
1. pricePattern:
   - Names: /\b(price|cost|amount|fee|total|subtotal|precio|costo|importe|prix|cout|montant|preis|kosten|betrag)\b/i
   - Types: ['number', 'string'] (string for "$19.99" format)
   - Values: number >= 0, or string matching /^\$?[\d,]+(\.\d{1,2})?$/
   - Formats: 'currency', 'decimal'

2. currencyCodePattern:
   - Names: /\b(currency|curr|currency_code)\b/i
   - Types: ['string']
   - Values: 3-letter uppercase (basic check /^[A-Z]{3}$/)
   - Formats: 'currency'

3. skuPattern:
   - Names: /\b(sku|product_code|item_code|article|upc|ean)\b/i
   - Types: ['string']
   - Values: alphanumeric 4-20 chars
   - Formats: none

4. quantityPattern:
   - Names: /\b(quantity|qty|count|stock|inventory)\b/i
   - Types: ['number', 'integer']
   - Values: integer >= 0
   - Formats: 'int32', 'int64'

**identity.ts** - 6 patterns:
1. emailPattern:
   - Names: /\b(email|e_mail|correo|courriel)\b/i
   - Types: ['string']
   - Values: email regex validation
   - Formats: 'email'

2. phonePattern:
   - Names: /\b(phone|tel|telephone|mobile|cell|telefono|telefon)\b/i
   - Types: ['string']
   - Values: E.164-like format /^\+?[\d\s\-()]{7,20}$/
   - Formats: 'phone'

3. uuidPattern:
   - Names: /\b(uuid|guid|id)\b/i (but 'id' alone needs value validation)
   - Types: ['string']
   - Values: UUID v4 regex /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i
   - Formats: 'uuid'

4. namePattern:
   - Names: /\b(name|nombre|nom|fullname|full_name|username)\b/i
   - Types: ['string']
   - Values: non-empty string, reasonable length
   - Formats: none

5. addressPattern:
   - Names: /\b(address|street|city|zip|postal|direccion|adresse)\b/i
   - Types: ['string']
   - Values: any string
   - Formats: none

6. urlPattern:
   - Names: /\b(url|link|href|website|webpage|uri)\b/i
   - Types: ['string']
   - Values: starts with http:// or https://
   - Formats: 'uri', 'url'

**media.ts** - 4 patterns:
1. imagePattern:
   - Names: /\b(image|img|photo|picture|imagen|bild)\b/i
   - Types: ['string']
   - Values: URL ending in image extensions or contains image hosting domains
   - Formats: 'uri'

2. videoPattern:
   - Names: /\b(video|movie|clip|film)\b/i
   - Types: ['string']
   - Values: URL with video extensions (.mp4, .webm, .mov) or video hosting
   - Formats: 'uri'

3. thumbnailPattern:
   - Names: /\b(thumb|thumbnail|preview|miniatura)\b/i
   - Types: ['string']
   - Values: image URL validation
   - Formats: 'uri'

4. avatarPattern:
   - Names: /\b(avatar|profile_pic|profile_image|user_image|foto_perfil)\b/i
   - Types: ['string']
   - Values: image URL validation
   - Formats: 'uri'

**engagement.ts** - 6 patterns:
1. ratingPattern:
   - Names: /\b(rating|score|stars|puntuacion|note|bewertung)\b/i
   - Types: ['number']
   - Values: number between 0-5 or 0-10 or 0-100
   - Formats: 'float', 'double'

2. reviewsPattern (COMPOSITE):
   - Names: /\b(reviews?|comments?|feedback|opiniones|avis|bewertungen)\b/i
   - Types: ['array']
   - RequiredFields: [{ nameRegex: /rating|score/i, type: 'number' }, { nameRegex: /comment|text|body|content/i, type: 'string' }]
   - Formats: none

3. tagsPattern:
   - Names: /\b(tags?|labels?|categories?|keywords?|etiquetas?)\b/i
   - Types: ['array']
   - Values: array of strings
   - Formats: none

4. statusPattern:
   - Names: /\b(status|state|stage|estado|statut|zustand)\b/i
   - Types: ['string']
   - Values: common status values (active, inactive, pending, completed, etc.)
   - Formats: none

5. titlePattern:
   - Names: /\b(title|headline|subject|heading|titulo|titre|titel)\b/i
   - Types: ['string']
   - Values: non-empty string
   - Formats: none

6. descriptionPattern:
   - Names: /\b(description|desc|summary|content|body|text|descripcion|beschreibung)\b/i
   - Types: ['string']
   - Values: longer string (> 20 chars typically)
   - Formats: none

**index.ts**:
- Import all patterns from each file
- Export getAllPatterns(): SemanticPattern[] (array of all ~22 patterns)
- Export getPattern(category: SemanticCategory): SemanticPattern | undefined
- Export getCompositePatterns(): CompositePattern[] (only composite patterns like reviews)

Use multilingual name patterns with alternation: /\b(price|precio|prix|preis)\b/i
  </action>
  <verify>
    - All 5 pattern files exist
    - `npx tsc --noEmit` passes
    - getAllPatterns returns array of 20-25 patterns
  </verify>
  <done>22 semantic patterns defined across 4 categories with multilingual support</done>
</task>

<task type="auto">
  <name>Task 2: Implement detection engine and public exports</name>
  <files>src/services/semantic/detector.ts, src/services/semantic/index.ts</files>
  <action>
Create `src/services/semantic/detector.ts`:

1. Import:
   - getAllPatterns, getCompositePatterns from ./patterns
   - calculateConfidence from ./scorer
   - createMemoizedDetector from ./cache
   - Types from ./types

2. detectSemantics function:
   ```typescript
   export function detectSemantics(
     fieldPath: string,
     fieldName: string,
     fieldType: string,
     sampleValues: unknown[],
     openapiHints?: { format?: string; description?: string }
   ): ConfidenceResult[]
   ```
   - Run calculateConfidence against all patterns from getAllPatterns()
   - Filter results where confidence > 0
   - Sort by confidence descending
   - Return top results (limit to 3 alternatives)
   - Wrap with memoization using createMemoizedDetector

3. detectCompositeSemantics function (for arrays):
   ```typescript
   export function detectCompositeSemantics(
     fieldPath: string,
     fieldName: string,
     itemFields: Array<{ name: string; type: string }>,
     sampleItems: unknown[]
   ): ConfidenceResult | null
   ```
   - Check composite patterns (e.g., reviews)
   - Validate array name matches pattern namePatterns
   - Validate item structure has required fields (check itemFields)
   - Return best match or null if no composite pattern matches

4. getBestMatch helper:
   ```typescript
   export function getBestMatch(results: ConfidenceResult[]): ConfidenceResult | null
   ```
   - Return first result if level is 'high' or 'medium' (confidence >= 0.75)
   - Return null otherwise (below threshold)

5. clearCache helper for testing:
   ```typescript
   export function clearSemanticCache(): void
   ```

Create `src/services/semantic/index.ts`:
- Export detectSemantics, detectCompositeSemantics, getBestMatch, clearSemanticCache
- Export types: SemanticCategory, ConfidenceResult, ConfidenceLevel, SemanticMetadata (from schema.ts)
- Export getAllPatterns for debugging/inspection
- Re-export key types from types.ts

This is the public API for Phase 13+.
  </action>
  <verify>
    - detector.ts and index.ts exist
    - `npx tsc --noEmit` passes
    - detectSemantics can be imported from src/services/semantic
  </verify>
  <done>Detection engine complete with memoized detectSemantics function</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - all files type-check
2. Pattern count: getAllPatterns().length should be 20-25
3. detectSemantics returns sorted ConfidenceResult[]
4. Composite detection works for array patterns
</verification>

<success_criteria>
- 22 semantic patterns defined with multilingual support
- detectSemantics function works for primitive fields
- detectCompositeSemantics function works for array fields
- Public API exported from src/services/semantic/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-semantic-detection/12-02-SUMMARY.md`
</output>
