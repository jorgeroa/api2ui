---
phase: 11-rich-input-components
plan: 07
type: execute
wave: 4
depends_on: ["11-05", "11-06"]
files_modified:
  - src/App.tsx
  - src/components/forms/ParameterForm.tsx
autonomous: false

must_haves:
  truths:
    - "Applied filter chips appear above results when filters active"
    - "Filter chips use sticky positioning"
    - "Removing a chip clears that filter and triggers re-fetch"
    - "'Clear all' removes all filters and triggers re-fetch"
    - "URL preview toggle appears below form"
    - "URL preview shows constructed URL"
    - "Copy button copies full URL"
    - "All Phase 11 success criteria are met"
  artifacts:
    - path: "src/App.tsx"
      provides: "Full integration with all Phase 11 components"
    - path: "src/components/forms/ParameterForm.tsx"
      provides: "AppliedFilters and URLPreview integration"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/forms/AppliedFilters.tsx"
      via: "Applied filter chips"
      pattern: "AppliedFilters"
    - from: "src/components/forms/ParameterForm.tsx"
      to: "src/components/forms/URLPreview.tsx"
      via: "URL preview below form"
      pattern: "URLPreview"
---

<objective>
Complete Phase 11 integration with AppliedFilters and URLPreview

Purpose: Wire AppliedFilters sticky bar and URLPreview toggle into the main application flow. This is the final integration step for Phase 11.

Output: Fully functional rich input components with applied filter chips and URL preview.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-rich-input-components/11-CONTEXT.md
@.planning/phases/11-rich-input-components/11-RESEARCH.md
@src/App.tsx
@src/components/forms/ParameterForm.tsx
@src/components/forms/AppliedFilters.tsx
@src/components/forms/URLPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URLPreview to ParameterForm</name>
  <files>
    src/components/forms/ParameterForm.tsx
  </files>
  <action>
Add URLPreview component at the bottom of ParameterForm, showing the constructed URL that will be fetched.

Add import:
```typescript
import { URLPreview } from './URLPreview'
```

Add prop for base URL:
```typescript
interface ParameterFormProps {
  // ... existing props ...
  baseUrl?: string  // For URL preview construction
}
```

Construct preview URL from current values:
```typescript
// Before the return statement, compute preview URL
const constructPreviewUrl = () => {
  if (!baseUrl && !endpoint) return ''

  const base = baseUrl ?? endpoint ?? ''
  const params = new URLSearchParams()

  for (const [key, value] of Object.entries(values)) {
    if (value) {
      params.set(key, value)
    }
  }

  const queryString = params.toString()
  return queryString ? `${base}?${queryString}` : base
}

const previewUrl = constructPreviewUrl()
```

Add URLPreview after the action buttons, before closing </form>:
```typescript
{/* URL Preview */}
{previewUrl && (
  <URLPreview url={previewUrl} />
)}
```

Note: The URLPreview will show/hide based on its internal toggle state (persisted in localStorage).
  </action>
  <verify>
- `grep "import.*URLPreview" src/components/forms/ParameterForm.tsx` shows import
- `grep "constructPreviewUrl" src/components/forms/ParameterForm.tsx` shows URL construction
- `grep "<URLPreview" src/components/forms/ParameterForm.tsx` shows component usage
- `npm run build` succeeds
  </verify>
  <done>
URLPreview integrated into ParameterForm showing constructed URL
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AppliedFilters to LayoutContainer/App.tsx</name>
  <files>
    src/App.tsx
  </files>
  <action>
The AppliedFilters bar should appear above the results area, showing active filters with remove buttons.

The challenge: AppliedFilters needs access to current filter values AND ability to trigger re-fetch. This is best done by:
1. Having ParameterForm expose current values
2. Or having AppliedFilters be a sibling to results that receives values from parent

Looking at the current App.tsx structure, the cleanest approach is to:
1. Add AppliedFilters as part of the results prop passed to LayoutContainer
2. Pass filter values and handlers from App.tsx

Actually, the simplest approach is to enhance ParameterForm to optionally render AppliedFilters:

Add to ParameterForm:
```typescript
import { AppliedFilters } from './AppliedFilters'

interface ParameterFormProps {
  // ... existing props ...
  showAppliedFilters?: boolean  // Render AppliedFilters above form
  onFilterRemove?: (key: string) => void  // Called when chip removed
  onFilterClearAll?: () => void  // Called when clear all clicked
}
```

But wait - AppliedFilters should be ABOVE RESULTS, not above the form. Per CONTEXT.md: "Sticky bar that persists while scrolling results"

So AppliedFilters goes in the RESULTS area, not the PARAMETERS area.

Modify App.tsx to include AppliedFilters in the results section:

```typescript
import { AppliedFilters } from '@/components/forms/AppliedFilters'
```

In the LayoutContainer results prop, add AppliedFilters before the actual results:

```typescript
results={
  <>
    {/* Applied Filter Chips */}
    <AppliedFilters
      filters={currentFilterValues}
      onRemove={(key) => {
        // Clear this filter and re-fetch
        handleFilterRemove(key)
      }}
      onClearAll={() => {
        // Clear all filters and re-fetch
        handleFilterClearAll()
      }}
    />

    {/* Existing results content */}
    {error && <ErrorDisplay error={error} />}
    {loading && <SkeletonTable />}
    {schema && data !== null && (
      <div className="border-t border-border pt-6">
        <DynamicRenderer ... />
      </div>
    )}
  </>
}
```

The challenge is getting currentFilterValues from ParameterForm. Options:
1. Lift state up to App.tsx (significant refactor)
2. Use a store (parameterStore already exists!)
3. Pass filter values via callback from ParameterForm

Using parameterStore is cleanest - it already tracks parameter values per endpoint.

In App.tsx:
```typescript
import { useParameterStore } from './store/parameterStore'

// Get current values for the active endpoint
const { getValues, clearValue, clearEndpoint } = useParameterStore()
const endpoint = parsedSpec && selectedOperation
  ? `${parsedSpec.baseUrl}${selectedOperation.path}`
  : (url?.split('?')[0] ?? '')
const currentValues = getValues(endpoint)

const handleFilterRemove = (key: string) => {
  clearValue(endpoint, key)
  // Trigger re-fetch with updated values
  handleParameterSubmit({ ...currentValues, [key]: '' })
}

const handleFilterClearAll = () => {
  clearEndpoint(endpoint)
  // Trigger re-fetch with empty values
  handleParameterSubmit({})
}
```

Apply this pattern to both the OpenAPI spec flow and the Direct API URL flow.
  </action>
  <verify>
- `grep "import.*AppliedFilters" src/App.tsx` shows import
- `grep "handleFilterRemove" src/App.tsx` shows remove handler
- `grep "handleFilterClearAll" src/App.tsx` shows clear all handler
- `npm run build` succeeds
  </verify>
  <done>
AppliedFilters integrated into results area with remove and clear all functionality
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 11 integration with all rich input components</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173

**Test Date Picker (FORM-01):**
- Load an API with date parameters (or use a URL with ?date=2024-01-15)
- Verify date field shows calendar picker on click
- Verify selecting a date updates the value

**Test Tag Input (FORM-02):**
- Find or create an array parameter
- Type a value and press Enter - verify chip appears
- Type a value and press comma - verify chip appears
- Try adding duplicate - verify error flash
- Click X on chip - verify it's removed

**Test Slider (FORM-05):**
- If you have a numeric parameter with min/max, verify slider appears
- Verify current value shown above track
- Verify min/max shown at ends

**Test Applied Filters (FETCH-05, FETCH-06):**
- Add some filter values and submit
- Verify filter chips appear above results (sticky bar)
- Scroll down - verify bar stays visible (sticky)
- Click X on a chip - verify filter removed and re-fetch triggered
- Click "Clear all" - verify all filters cleared

**Test URL Preview (FETCH-07):**
- Look below the form for "Show URL Preview" toggle
- Click to show preview
- Verify constructed URL is displayed
- Click Copy - verify URL copied to clipboard
- Refresh page - verify toggle state persisted

**Test Hybrid Re-fetch (FETCH-01, FETCH-02):**
- Type in a text field - verify NO automatic fetch
- Click Apply - verify fetch happens
- If there's a select/checkbox, change it - verify fetch after ~300ms

**Test Error Toast (FETCH-03):**
- Cause a fetch error (invalid URL, network error)
- Verify toast notification appears bottom-right
- Verify previous results remain visible

**Test Inline Validation (FORM-03):**
- Find a required field
- Click into it, then click out without entering value
- Verify error appears ("This field is required")
- Type a value - verify error clears
  </how-to-verify>
  <resume-signal>Type "approved" if all Phase 11 success criteria are met, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks and checkpoint complete:

1. All 7 Phase 11 success criteria from ROADMAP.md are met:
   - [ ] Date/datetime fields show calendar picker
   - [ ] Array parameters render as tag input with chip UI
   - [ ] Numeric ranges show slider when min/max known
   - [ ] Inline validation on blur
   - [ ] Applied filter chips above results with Clear all
   - [ ] Smooth inline re-fetch with loading state
   - [ ] URL preview shows what will be fetched

2. All 13 requirements addressed:
   - FORM-01 through FORM-06
   - FETCH-01 through FETCH-07 (FETCH-04 already done in Phase 9)
</verification>

<success_criteria>
- All new components render correctly
- Date picker shows calendar
- Tag input handles Enter/comma
- Slider shows for bounded numerics
- Applied filters sticky bar works
- URL preview toggle persists
- Hybrid re-fetch behavior correct
- Error toast appears on failure
- Build succeeds
- All manual tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-rich-input-components/11-07-SUMMARY.md`
</output>
