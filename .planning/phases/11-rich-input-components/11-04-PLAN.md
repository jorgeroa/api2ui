---
phase: 11-rich-input-components
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/forms/AppliedFilters.tsx
  - src/components/forms/URLPreview.tsx
  - src/hooks/useLocalStorage.ts
  - src/hooks/useCopyToClipboard.ts
autonomous: true

must_haves:
  truths:
    - "Applied filters bar appears only when filters are active"
    - "Applied filters bar uses position: sticky"
    - "Filter chips show 'key: value' format"
    - "Clicking X on chip removes that filter"
    - "'Clear all' button removes all filters"
    - "URL preview toggle hidden by default"
    - "URL preview toggle state persists in localStorage"
    - "Copy button copies full URL to clipboard"
  artifacts:
    - path: "src/components/forms/AppliedFilters.tsx"
      provides: "Sticky filter chips bar"
      exports: ["AppliedFilters"]
    - path: "src/components/forms/URLPreview.tsx"
      provides: "URL preview with copy button"
      exports: ["URLPreview"]
    - path: "src/hooks/useLocalStorage.ts"
      provides: "localStorage hook with SSR safety"
      exports: ["useLocalStorage"]
    - path: "src/hooks/useCopyToClipboard.ts"
      provides: "Clipboard copy hook"
      exports: ["useCopyToClipboard"]
  key_links:
    - from: "src/components/forms/AppliedFilters.tsx"
      to: "@/components/ui/badge"
      via: "Badge component import"
      pattern: "import.*Badge.*from.*@/components/ui"
    - from: "src/components/forms/URLPreview.tsx"
      to: "src/hooks/useLocalStorage.ts"
      via: "useLocalStorage hook"
      pattern: "useLocalStorage.*url-preview"
---

<objective>
Create AppliedFilters sticky bar and URLPreview toggle components

Purpose: Provide visual feedback for active filters (sticky chip bar) and URL preview with copy functionality. Both are core UX features per CONTEXT.md decisions.

Output: Two display components plus supporting hooks for localStorage and clipboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-rich-input-components/11-CONTEXT.md
@.planning/phases/11-rich-input-components/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create supporting hooks</name>
  <files>
    src/hooks/useLocalStorage.ts
    src/hooks/useCopyToClipboard.ts
  </files>
  <action>
Create useLocalStorage hook at src/hooks/useLocalStorage.ts:

```typescript
import { useState, useEffect } from 'react'

export function useLocalStorage<T>(
  key: string,
  initialValue: T
): [T, (value: T) => void] {
  // Use lazy initialization to avoid SSR issues (pitfall #7)
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') {
      return initialValue
    }
    try {
      const item = window.localStorage.getItem(key)
      return item ? (JSON.parse(item) as T) : initialValue
    } catch (error) {
      console.error(`Error reading localStorage key "${key}":`, error)
      return initialValue
    }
  })

  // Sync to localStorage when value changes
  useEffect(() => {
    if (typeof window === 'undefined') return
    try {
      window.localStorage.setItem(key, JSON.stringify(storedValue))
    } catch (error) {
      console.error(`Error writing localStorage key "${key}":`, error)
    }
  }, [key, storedValue])

  return [storedValue, setStoredValue]
}
```

Create useCopyToClipboard hook at src/hooks/useCopyToClipboard.ts:

```typescript
import { useState, useCallback } from 'react'

interface UseCopyToClipboardResult {
  copy: (text: string) => Promise<void>
  isCopied: boolean
}

export function useCopyToClipboard(): UseCopyToClipboardResult {
  const [isCopied, setIsCopied] = useState(false)

  const copy = useCallback(async (text: string) => {
    if (!navigator?.clipboard) {
      console.error('Clipboard API not available')
      return
    }

    try {
      await navigator.clipboard.writeText(text)
      setIsCopied(true)
      setTimeout(() => setIsCopied(false), 2000)
    } catch (error) {
      console.error('Failed to copy to clipboard:', error)
    }
  }, [])

  return { copy, isCopied }
}
```

Key implementation notes:
- useLocalStorage handles SSR safety (typeof window check)
- useLocalStorage uses lazy initialization
- useCopyToClipboard uses modern Clipboard API
- Both hooks are reusable for other features
  </action>
  <verify>
- `cat src/hooks/useLocalStorage.ts` shows hook
- `cat src/hooks/useCopyToClipboard.ts` shows hook
- `grep "typeof window" src/hooks/useLocalStorage.ts` shows SSR check
- `npm run build` succeeds
  </verify>
  <done>
useLocalStorage and useCopyToClipboard hooks created
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AppliedFilters component</name>
  <files>
    src/components/forms/AppliedFilters.tsx
  </files>
  <action>
Create AppliedFilters sticky bar component:

```typescript
import { Badge } from '@/components/ui/badge'

interface AppliedFiltersProps {
  filters: Record<string, string>
  onRemove: (key: string) => void
  onClearAll: () => void
}

export function AppliedFilters({
  filters,
  onRemove,
  onClearAll,
}: AppliedFiltersProps) {
  // Filter out empty values
  const activeFilters = Object.entries(filters).filter(
    ([_, value]) => value !== '' && value !== undefined
  )

  // Don't render if no active filters
  if (activeFilters.length === 0) {
    return null
  }

  return (
    <div className="sticky top-0 z-10 bg-white border-b border-gray-200 py-2 px-4 flex items-center gap-2 flex-wrap shadow-sm">
      <span className="text-sm font-medium text-gray-600 shrink-0">
        Filters:
      </span>

      {activeFilters.map(([key, value]) => (
        <Badge key={key} variant="secondary" className="gap-1 max-w-[200px]">
          <span className="truncate">
            {key}: {value}
          </span>
          <button
            type="button"
            onClick={() => onRemove(key)}
            className="ml-0.5 rounded-full hover:bg-gray-300 p-0.5 shrink-0"
            aria-label={`Remove filter ${key}`}
          >
            <svg
              className="h-3 w-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </Badge>
      ))}

      <button
        type="button"
        onClick={onClearAll}
        className="ml-auto text-sm text-gray-500 hover:text-gray-700 hover:underline shrink-0"
      >
        Clear all
      </button>
    </div>
  )
}
```

Key implementation notes:
- Uses position: sticky with top-0 z-10 (per research)
- Shows "key: value" format (CONTEXT.md decision)
- "Clear all" at end of row (CONTEXT.md decision)
- Hidden when no filters (CONTEXT.md decision)
- Truncates long values with max-width
- Uses shadcn Badge for chips
  </action>
  <verify>
- `cat src/components/forms/AppliedFilters.tsx` shows component
- `grep "sticky top-0" src/components/forms/AppliedFilters.tsx` shows sticky positioning
- `grep "Clear all" src/components/forms/AppliedFilters.tsx` shows clear button
- `npm run build` succeeds
  </verify>
  <done>
AppliedFilters sticky bar component created
  </done>
</task>

<task type="auto">
  <name>Task 3: Create URLPreview component</name>
  <files>
    src/components/forms/URLPreview.tsx
  </files>
  <action>
Create URLPreview toggle component:

```typescript
import { Button } from '@/components/ui/button'
import { useLocalStorage } from '@/hooks/useLocalStorage'
import { useCopyToClipboard } from '@/hooks/useCopyToClipboard'

interface URLPreviewProps {
  url: string
}

export function URLPreview({ url }: URLPreviewProps) {
  const [showPreview, setShowPreview] = useLocalStorage('url-preview-visible', false)
  const { copy, isCopied } = useCopyToClipboard()

  // Truncate URL for display (CONTEXT.md: long URLs truncated with ellipsis)
  const truncatedUrl = url.length > 80 ? url.slice(0, 77) + '...' : url

  return (
    <div className="border-t border-gray-200 pt-3 mt-4">
      <button
        type="button"
        onClick={() => setShowPreview(!showPreview)}
        className="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1"
      >
        <svg
          className={`h-4 w-4 transition-transform ${showPreview ? 'rotate-90' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 5l7 7-7 7"
          />
        </svg>
        {showPreview ? 'Hide' : 'Show'} URL Preview
      </button>

      {showPreview && (
        <div className="mt-2 p-3 bg-gray-50 rounded-md flex items-center gap-2">
          <code className="text-xs flex-1 overflow-hidden text-gray-700 font-mono">
            {truncatedUrl}
          </code>
          <Button
            size="sm"
            variant="outline"
            onClick={() => copy(url)}
            className="shrink-0"
          >
            {isCopied ? (
              <>
                <svg
                  className="h-4 w-4 mr-1 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                Copied!
              </>
            ) : (
              <>
                <svg
                  className="h-4 w-4 mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
                Copy
              </>
            )}
          </Button>
        </div>
      )}
    </div>
  )
}
```

Key implementation notes:
- Toggle hidden by default (CONTEXT.md decision)
- Toggle state persists in localStorage (CONTEXT.md decision)
- Copy button copies FULL URL, not truncated (CONTEXT.md decision)
- Uses useLocalStorage and useCopyToClipboard hooks
- Uses shadcn Button
- Shows checkmark after successful copy
  </action>
  <verify>
- `cat src/components/forms/URLPreview.tsx` shows component
- `grep "useLocalStorage.*url-preview" src/components/forms/URLPreview.tsx` shows localStorage key
- `grep "copy(url)" src/components/forms/URLPreview.tsx` shows full URL copy
- `npm run build` succeeds
  </verify>
  <done>
URLPreview toggle component created with copy and localStorage persistence
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run `npm run build` - should succeed
2. Verify all files exist:
   - src/hooks/useLocalStorage.ts
   - src/hooks/useCopyToClipboard.ts
   - src/components/forms/AppliedFilters.tsx
   - src/components/forms/URLPreview.tsx
3. Verify AppliedFilters uses sticky positioning
4. Verify URLPreview uses localStorage for toggle state
5. Verify hooks handle edge cases (SSR, clipboard unavailable)
</verification>

<success_criteria>
- AppliedFilters renders only with active filters
- AppliedFilters uses sticky positioning
- AppliedFilters shows "key: value" chips with remove buttons
- AppliedFilters has "Clear all" button
- URLPreview hidden by default
- URLPreview toggle persists in localStorage
- URLPreview copy button copies full URL
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-rich-input-components/11-04-SUMMARY.md`
</output>
