---
phase: 18-fetch-integration
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/hooks/useAPIFetch.ts
  - src/services/api/fetcher.ts
autonomous: true

must_haves:
  truths:
    - "fetchAndInfer uses fetchWithAuth instead of fetchAPI"
    - "fetchOperation uses fetchWithAuth instead of fetchAPI"
    - "Public APIs without credentials behave identically to v1.3"
    - "TypeScript builds cleanly with no errors"
    - "Existing tests still pass"
  artifacts:
    - path: "src/hooks/useAPIFetch.ts"
      provides: "Updated hook using fetchWithAuth for authenticated API calls"
      contains: "fetchWithAuth"
    - path: "src/services/api/fetcher.ts"
      provides: "fetchWithAuth as named export alongside fetchAPI"
      exports: ["fetchWithAuth", "fetchAPI", "isAuthConfigured"]
  key_links:
    - from: "src/hooks/useAPIFetch.ts"
      to: "src/services/api/fetcher.ts"
      via: "import { fetchWithAuth }"
      pattern: "import.*fetchWithAuth.*from.*fetcher"
    - from: "src/services/api/fetcher.ts"
      to: "src/store/authStore.ts"
      via: "useAuthStore.getState().getActiveCredential"
      pattern: "getActiveCredential"
---

<objective>
Wire `fetchWithAuth` into the application's fetch paths and verify zero regression on public APIs.

Purpose: Make auth injection live in the actual application. Plan 01 built the engine; this plan connects it.
Output: All API data fetching goes through `fetchWithAuth`, enabling authenticated requests once credentials are configured (Phase 19 UI).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fetch-integration/18-01-SUMMARY.md

@src/hooks/useAPIFetch.ts
@src/services/api/fetcher.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace fetchAPI with fetchWithAuth in useAPIFetch hook</name>
  <files>src/hooks/useAPIFetch.ts</files>
  <action>
    Update the import statement to import `fetchWithAuth` instead of (or in addition to) `fetchAPI` from `../services/api/fetcher`.

    Replace the two `fetchAPI` call sites with `fetchWithAuth`:
    1. Line ~94 in `fetchOperation`: `const data = await fetchAPI(fullUrl)` → `const data = await fetchWithAuth(fullUrl)`
    2. Line ~128 in `fetchAndInfer`: `const data = await fetchAPI(url)` → `const data = await fetchWithAuth(url)`

    Do NOT change `fetchSpec` — it uses raw `fetch()` for OpenAPI specs, which is correct (spec fetching doesn't need auth injection, and it has its own error handling).

    Keep the import of `fetchAPI` if any other code in the file still uses it, otherwise remove it.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `grep -n 'fetchAPI' src/hooks/useAPIFetch.ts` returns zero matches (only fetchWithAuth used)
    - `grep -n 'fetchWithAuth' src/hooks/useAPIFetch.ts` returns 3 matches (1 import + 2 call sites)
  </verify>
  <done>useAPIFetch hook uses fetchWithAuth for all data fetching, fetchSpec unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Build verification and full test suite regression check</name>
  <files>src/hooks/useAPIFetch.ts, src/services/api/fetcher.ts</files>
  <action>
    Run the full project build and test suite to verify zero regression:

    1. Run `npx tsc --noEmit` to verify TypeScript compilation
    2. Run `npx vitest run` to execute all tests
    3. Run `npx vite build` to verify production build succeeds

    If any test failures occur, diagnose and fix. The most likely issues:
    - Import paths not matching (use relative imports)
    - Type mismatches between fetchWithAuth and fetchAPI return types (both return Promise<unknown>)

    If all passes, the integration is complete. Public APIs continue working because fetchWithAuth passes through to the same fetch logic when no credentials are configured.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `npx vitest run` exits 0 with all tests passing
    - `npx vite build` exits 0
  </verify>
  <done>Full build and test suite passes. Zero regression on public API behavior.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles cleanly
2. `npx vitest run` — all existing + new tests pass
3. `npx vite build` — production build succeeds
4. `grep -rn 'fetchAPI' src/hooks/` — no remaining direct fetchAPI calls in hooks
5. `grep -rn 'fetchWithAuth' src/hooks/useAPIFetch.ts` — fetchWithAuth is used in both data-fetching paths
</verification>

<success_criteria>
- useAPIFetch.ts imports and uses fetchWithAuth (not fetchAPI)
- TypeScript compiles without errors
- All existing tests pass (regression safety)
- Production build succeeds
- fetchSpec still uses raw fetch() (not modified)
</success_criteria>

<output>
After completion, create `.planning/phases/18-fetch-integration/18-02-SUMMARY.md`
</output>
