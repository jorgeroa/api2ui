---
phase: 03-configuration-system
plan: 04
type: execute
wave: 4
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/components/config/ComponentPicker.tsx
  - src/components/config/ScopeDialog.tsx
  - src/components/config/ComponentOverridePanel.tsx
  - src/components/config/ConfigPanel.tsx
  - src/components/renderers/CardListRenderer.tsx
  - src/components/renderers/ListRenderer.tsx
  - src/components/renderers/PrimitiveRenderer.tsx
  - src/components/registry/ComponentRegistry.tsx
  - src/components/DynamicRenderer.tsx
autonomous: true

must_haves:
  truths:
    - "User can override component type for array fields (Table, Cards, List, Raw JSON)"
    - "Visual preview picker shows thumbnail of each component option"
    - "Override prompts: apply to just this field or all similar fields"
    - "Overridden component renders in both Configure and View mode"
    - "Panel Components section lists all overrides with option to change or revert"
    - "Primitive string fields detected as URLs offer link/text/image render modes"
    - "Primitive date fields offer relative and absolute render modes"
    - "ComponentPicker shows type-appropriate options for primitive fields, not just arrays"
  artifacts:
    - path: "src/components/config/ComponentPicker.tsx"
      provides: "Visual preview picker with thumbnails for component alternatives, including primitive field render modes"
      exports: ["ComponentPicker"]
    - path: "src/components/config/ScopeDialog.tsx"
      provides: "Dialog asking apply to this field or all similar fields"
      exports: ["ScopeDialog"]
    - path: "src/components/config/ComponentOverridePanel.tsx"
      provides: "Panel section listing active component overrides"
      exports: ["ComponentOverridePanel"]
    - path: "src/components/renderers/CardListRenderer.tsx"
      provides: "Card list renderer for array of objects"
      exports: ["CardListRenderer"]
    - path: "src/components/renderers/ListRenderer.tsx"
      provides: "Simple list renderer for array of objects"
      exports: ["ListRenderer"]
    - path: "src/components/renderers/PrimitiveRenderer.tsx"
      provides: "PrimitiveRenderer extended with render mode support for URL and date fields"
      contains: "renderMode"
    - path: "src/components/registry/ComponentRegistry.tsx"
      provides: "Registry with getComponent accepting optional override"
      contains: "override"
    - path: "src/components/DynamicRenderer.tsx"
      provides: "DynamicRenderer reads config store for component overrides"
      contains: "useConfigStore"
  key_links:
    - from: "src/components/DynamicRenderer.tsx"
      to: "src/store/configStore.ts"
      via: "reads componentType override from fieldConfigs"
      pattern: "useConfigStore|fieldConfigs"
    - from: "src/components/DynamicRenderer.tsx"
      to: "src/components/registry/ComponentRegistry.tsx"
      via: "passes override to getComponent"
      pattern: "getComponent"
    - from: "src/components/config/ComponentPicker.tsx"
      to: "src/store/configStore.ts"
      via: "setFieldComponentType action"
      pattern: "setFieldComponentType"
    - from: "src/components/renderers/PrimitiveRenderer.tsx"
      to: "src/store/configStore.ts"
      via: "reads componentType from fieldConfigs for render mode"
      pattern: "useConfigStore|componentType"
---

<objective>
Add component type override capability with visual preview picker, "apply to similar" scope dialog, and primitive field render mode variants (URL link/text/image, date relative/absolute).

Purpose: This delivers CFG-03 (component type overrides), enabling users to change how array data renders -- switching between Table, Cards, List, and Raw JSON views -- and how individual primitive fields render with type-appropriate alternatives. This is the core customization feature of the configuration system.

Output: ComponentPicker (visual preview for both array and primitive types), ScopeDialog (apply scope), two new renderers (CardList, List), extended PrimitiveRenderer with render modes, updated registry and DynamicRenderer to respect overrides.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-configuration-system/03-RESEARCH.md
@.planning/phases/03-configuration-system/03-CONTEXT.md
@src/store/configStore.ts
@src/types/config.ts
@src/types/components.ts
@src/types/schema.ts
@src/components/registry/ComponentRegistry.tsx
@src/components/DynamicRenderer.tsx
@src/components/renderers/TableRenderer.tsx
@src/components/renderers/PrimitiveRenderer.tsx
@src/components/config/ConfigPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardList and List renderers, extend PrimitiveRenderer with render modes, update registry</name>
  <files>src/components/renderers/CardListRenderer.tsx, src/components/renderers/ListRenderer.tsx, src/components/renderers/PrimitiveRenderer.tsx, src/components/registry/ComponentRegistry.tsx, src/components/DynamicRenderer.tsx</files>
  <action>
**CardListRenderer.tsx** - Grid of cards for array of objects:
- Accepts RendererProps (same as TableRenderer)
- Renders array items as a responsive grid of cards: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
- Each card: rounded border, padding, shadow-sm
- Card content: show first 4-5 fields as key-value pairs. Use smart title extraction (check name, title, label, id - same pattern as DetailModal) for card header.
- Click on card opens DetailModal (same pattern as TableRenderer)
- Handle empty array: "No data" message
- Guard against wrong schema kind

**ListRenderer.tsx** - Simple vertical list for array of objects:
- Accepts RendererProps
- Renders array items as a vertical list with dividers
- Each item: single line showing smart title + 2-3 key field values inline
- Click expands to show full detail (or opens DetailModal)
- Minimal styling: border-b between items, hover highlight

**PrimitiveRenderer.tsx** - Extend with render mode support:
- Read `fieldConfigs` and `mode` from configStore via `useConfigStore`
- The component receives a `path` prop (from DynamicRenderer). Use it to look up `fieldConfigs[path]?.componentType` for the render mode.
- Add URL detection: check if a string value matches a URL pattern (starts with http:// or https://, or matches a common URL regex). This detection is used to determine what render mode options are available.
- Add date detection: check if a string value looks like an ISO date (matches ISO 8601 pattern) or if the field name contains common date keywords (date, created, updated, timestamp).
- Render modes for string fields detected as URLs:
  - `'text'` (default): render as plain text (current behavior)
  - `'link'`: render as a clickable `<a href={value} target="_blank" rel="noopener noreferrer">` with link styling (underline, blue color)
  - `'image'`: render as an `<img src={value} alt={fieldName}>` with max-height ~200px, object-contain, and error fallback (show URL as text if image fails to load, use onError handler)
- Render modes for date fields:
  - `'absolute'` (default): render the formatted date string (current behavior, or use `toLocaleDateString()` / `toLocaleString()`)
  - `'relative'`: render relative time (e.g., "2 hours ago", "3 days ago"). Implement a simple `timeAgo(date: Date): string` helper function -- do NOT add a library. Handle: seconds, minutes, hours, days, weeks, months, years.
- When no render mode override is set, use current default behavior (no change).
- Export a helper: `getAvailableRenderModes(value: unknown, fieldName: string): string[]` that returns the applicable render modes for a given value. This is consumed by ComponentPicker.
  - URL string: ['text', 'link', 'image']
  - Date string: ['absolute', 'relative']
  - Other string: ['text'] (no alternatives)
  - Number/boolean/null: ['text'] (no alternatives)

**ComponentRegistry.tsx** - Add override support:
1. Import CardListRenderer and ListRenderer
2. Add them to the registry array (they match same schemas as TableRenderer)
3. Add a new export: `getComponentByType(type: string): RendererComponent | undefined` that maps string type names to components:
   - 'table' -> TableRenderer
   - 'card-list' -> CardListRenderer
   - 'list' -> ListRenderer
   - 'json' -> JsonFallback
   - 'detail' -> DetailRenderer
   - 'primitive' -> PrimitiveRenderer
   - 'primitive-list' -> PrimitiveListRenderer
4. Update `getComponent` signature to accept optional override: `getComponent(typeSignature: TypeSignature, override?: string): RendererComponent`
   - If override is provided, use `getComponentByType(override)` first; fall back to default matching if override not found
   - If no override, use existing match logic (unchanged behavior)

**DynamicRenderer.tsx** - Read config store for overrides:
1. Import `useConfigStore` from store
2. Read `fieldConfigs` and `mode` from store
3. Look up `fieldConfigs[path]?.componentType` for the current path
4. Pass override to `getComponent(schema, override)` if it exists
5. In Configure mode: show a small component-type badge/indicator on the rendered component (e.g., "Table" tag in corner) that when clicked opens the ComponentPicker
6. PRESERVE all existing behavior: depth guard, path passing, fallback to JsonFallback

IMPORTANT: Do NOT break the existing default rendering. When no override exists in config, behavior must be identical to current. Override is purely additive. PrimitiveRenderer render modes only activate when componentType is explicitly set in fieldConfigs.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run build` - build succeeds.
Run `npm run test:run` - existing tests pass.
  </verify>
  <done>
CardListRenderer and ListRenderer created. PrimitiveRenderer extended with URL render modes (text/link/image) and date render modes (absolute/relative). Registry supports getComponentByType lookup. getComponent accepts optional override string. DynamicRenderer reads configStore for component overrides. Default rendering unchanged when no overrides exist. getAvailableRenderModes exported for ComponentPicker consumption.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ComponentPicker with primitive field support, ScopeDialog, and panel section</name>
  <files>src/components/config/ComponentPicker.tsx, src/components/config/ScopeDialog.tsx, src/components/config/ComponentOverridePanel.tsx, src/components/config/ConfigPanel.tsx</files>
  <action>
**ComponentPicker.tsx** - Visual preview picker for component alternatives:
- Props: `currentType: string`, `availableTypes: string[]`, `fieldPath: string`, `fieldValue?: unknown`, `fieldName?: string`, `sampleData: unknown`, `sampleSchema: TypeSignature`, `onSelect: (type: string) => void`, `onClose: () => void`
- Render as a popover or small dialog near the clicked component
- Grid layout (2 columns) showing each available type as a button
- For array component types (table, card-list, list, json):
  - Each button contains a scaled-down preview of the component rendered with sample data: use `transform: scale(0.5)` with `origin-top-left` and `pointer-events-none` on a container with overflow-hidden and fixed height (~120px)
  - Render the actual component (TableRenderer, CardListRenderer, etc.) with sample data at small scale for live preview
  - Type name label below preview
- For primitive field render modes (text, link, image, absolute, relative):
  - Each button shows a small preview of how the value would render in that mode
  - For 'link': show the value as underlined blue text
  - For 'image': show a tiny thumbnail preview (or image icon if no value available)
  - For 'text': show plain text
  - For 'relative': show sample relative time string (e.g., "2 hours ago")
  - For 'absolute': show formatted date string
  - Type name label below preview
- Currently selected type has highlighted border (ring-2 ring-blue-500)
- Determine compatible types based on context:
  - Array of objects: ['table', 'card-list', 'list', 'json']
  - Object: ['detail', 'json']
  - Primitive fields: use `getAvailableRenderModes(fieldValue, fieldName)` from PrimitiveRenderer to get applicable modes. Only show picker if more than 1 mode is available.
- When opened for a primitive field, pass `fieldValue` and `fieldName` so the picker can determine available render modes

**ScopeDialog.tsx** - "Apply to this field or all similar?" prompt:
- Props: `fieldPath: string`, `componentType: string`, `similarFields: Array<{path: string, name: string}>`, `onApplyOne: () => void`, `onApplyAll: () => void`, `onCancel: () => void`
- Use Headless UI Dialog (small modal)
- Shows: "Apply {componentType} to:" with two options:
  - "Just this field ({fieldPath})" - button
  - "All similar fields ({count} fields with same type)" - button, lists the similar field paths
- Define "similar" as: same TypeSignature kind + same items kind for arrays; same detected type (URL/date) for primitives (per research open question #2)
- If no similar fields exist, skip dialog and apply directly

**ComponentOverridePanel.tsx** - Panel section for component overrides:
- Props: none (reads from configStore)
- Lists all active component overrides from fieldConfigs (entries where componentType is set)
- Each override row: field path, current override type (including render modes like "link", "image", "relative"), "Change" button (reopens picker), "Revert" button (clears componentType)
- If no overrides: "No component overrides. Enter Configure mode to change component types."

**ConfigPanel.tsx** - Wire Components section:
- Replace Components placeholder with ComponentOverridePanel
- Import ComponentOverridePanel and render in the Components section

IMPORTANT: For preview thumbnails of array components, render actual components but wrap in a container with `overflow-hidden`, `h-[120px]`, `w-full`, and the inner content scaled with `transform: scale(0.5)` and `transform-origin: top left`. Use `pointer-events-none` to prevent interaction with preview content. For primitive render mode previews, use simpler inline examples rather than scaled-down components.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run build` - build succeeds.
Verify: In Configure mode, clicking component badge opens picker. Selecting different type changes rendering. ScopeDialog appears when similar fields exist. For URL fields, picker shows text/link/image options. For date fields, picker shows absolute/relative options.
  </verify>
  <done>
ComponentPicker shows visual previews of component alternatives for both array types and primitive field render modes. ScopeDialog prompts for apply scope (works for both array and primitive overrides). ComponentOverridePanel lists active overrides including render modes in panel. ConfigPanel Components section is wired. Component type overrides and primitive render mode overrides work end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. `npm run test:run` - existing tests pass
4. CardListRenderer renders array data as card grid
5. ListRenderer renders array data as vertical list
6. Component override changes rendering from default
7. Preview picker shows live previews at reduced scale
8. Scope dialog appears when similar fields exist
9. Panel shows active overrides with change/revert options
10. Default rendering unchanged when no overrides configured
11. URL fields can be switched to link/text/image render modes
12. Date fields can be switched to relative/absolute render modes
13. ComponentPicker shows type-appropriate options for both arrays and primitives
</verification>

<success_criteria>
- Array of objects can render as Table (default), Cards, List, or Raw JSON
- URL string fields can render as text (default), clickable link, or image preview
- Date string fields can render as absolute (default) or relative time
- Visual preview picker shows live thumbnails for array types and inline previews for primitive modes
- "Apply to all similar fields?" dialog appears when applicable (works for both array and primitive types)
- Overrides persist in localStorage across refresh
- Panel Components section lists all active overrides (including render mode overrides)
- Reverting an override returns to default component/render mode
- No regression in existing rendering behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-configuration-system/03-04-SUMMARY.md`
</output>
