---
phase: 03-configuration-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/configStore.ts
  - src/types/config.ts
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "Configuration store exists with persist middleware saving to localStorage"
    - "Mode state toggles between 'configure' and 'view'"
    - "Field configs (visibility, label, componentType, order) are stored per path"
    - "Theme CSS variables are defined and theme preset classes exist"
    - "Style overrides are persisted and applied at runtime"
  artifacts:
    - path: "src/store/configStore.ts"
      provides: "Configuration state management with localStorage persistence"
      exports: ["useConfigStore"]
      contains: "persist"
    - path: "src/types/config.ts"
      provides: "TypeScript interfaces for configuration state"
      exports: ["FieldConfig", "ThemePreset", "StyleOverrides", "ConfigState"]
    - path: "src/index.css"
      provides: "Theme CSS variables and preset classes"
      contains: "@theme"
  key_links:
    - from: "src/store/configStore.ts"
      to: "src/types/config.ts"
      via: "imports FieldConfig, StyleOverrides types"
      pattern: "import.*config"
    - from: "src/store/configStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist.*localStorage"
---

<objective>
Create the configuration store with localStorage persistence and CSS theme variable infrastructure.

Purpose: This is the data foundation for the entire configuration system. Every subsequent plan reads from and writes to this store. The theme CSS variables enable runtime style customization without rebuilding CSS.

Output: configStore.ts (Zustand store with persist), config types, theme CSS variables and preset classes in index.css.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-configuration-system/03-RESEARCH.md
@.planning/phases/03-configuration-system/03-CONTEXT.md
@src/store/appStore.ts
@src/types/schema.ts
@src/types/components.ts
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration types and Zustand store with persist</name>
  <files>src/types/config.ts, src/store/configStore.ts</files>
  <action>
Create `src/types/config.ts` with these interfaces:

```typescript
export interface FieldConfig {
  visible: boolean
  label?: string           // custom display label (undefined = use original)
  componentType?: string   // override component type (undefined = use default)
  order: number            // sort order for drag-and-drop reordering
}

export type ThemePreset = 'light' | 'dark' | 'compact' | 'spacious'

export interface StyleOverrides {
  '--color-primary'?: string
  '--color-secondary'?: string
  '--color-background'?: string
  '--color-text'?: string
  '--color-surface'?: string
  '--color-border'?: string
  '--spacing-row'?: string
  '--font-family'?: string
  '--font-size-base'?: string
  '--border-radius-base'?: string
  [key: `--${string}`]: string | undefined  // allow additional CSS vars
}
```

Create `src/store/configStore.ts` using Zustand 5 with persist middleware:

- State shape:
  - `mode: 'configure' | 'view'` (default: 'view', NOT persisted - always start in View mode)
  - `fieldConfigs: Record<string, FieldConfig>` (keyed by field path like $.name, $.items[].title)
  - `globalTheme: ThemePreset` (default: 'light')
  - `styleOverrides: StyleOverrides` (default: {})
  - `panelOpen: boolean` (default: false, NOT persisted)

- Actions (all using functional set() to avoid stale closures):
  - `setMode(mode)` - toggle configure/view
  - `togglePanel()` - open/close side panel
  - `setFieldConfig(path, config: Partial<FieldConfig>)` - update single field config, deep-merging with existing
  - `toggleFieldVisibility(path)` - toggle visible boolean, creating entry with visible:false if doesn't exist
  - `setFieldLabel(path, label)` - set custom label
  - `setFieldComponentType(path, componentType)` - set component override
  - `setFieldOrder(path, order)` - set sort order
  - `reorderFields(orderedPaths: string[])` - bulk update orders from drag result
  - `applyTheme(theme: ThemePreset)` - set theme preset
  - `setStyleOverride(key, value)` - set single CSS variable override
  - `setStyleOverrides(overrides: StyleOverrides)` - bulk set overrides
  - `resetConfig()` - clear all field configs and style overrides
  - `getHiddenFieldCount()` - derived: count fields with visible === false
  - `getFieldConfig(path)` - get config for path, returning default (visible: true, order: 0) if not set

- Persist configuration:
  - Storage name: `'api2ui-config'`
  - version: 1
  - Use `createJSONStorage(() => localStorage)`
  - `partialize`: exclude `mode` and `panelOpen` (ephemeral UI state)
  - `merge`: use deep merge to avoid shallow merge erasing nested config fields. Implement a simple deepMerge helper (don't import lodash) that handles plain objects recursively. Arrays should be replaced, not merged.

IMPORTANT: Use functional `set((state) => ...)` for ALL actions that read current state to avoid stale closures (research pitfall #8).
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Write a quick sanity check: import useConfigStore, call setMode, toggleFieldVisibility, applyTheme - verify no runtime errors.
  </verify>
  <done>
configStore.ts exports useConfigStore with all listed actions. Types are correctly defined. persist middleware is configured with partialize excluding mode/panelOpen. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add theme CSS variables and preset classes</name>
  <files>src/index.css</files>
  <action>
Update `src/index.css` to add theme infrastructure after the existing `@import "tailwindcss"` line:

```css
@import "tailwindcss";

@theme {
  --color-primary: #3b82f6;
  --color-secondary: #8b5cf6;
  --color-background: #f9fafb;
  --color-text: #1f2937;
  --color-surface: #ffffff;
  --color-border: #e5e7eb;
  --spacing-row: 0.5rem;
  --font-size-base: 1rem;
  --border-radius-base: 0.375rem;
}
```

Add theme preset classes in a `@layer base` block:

- `.theme-light`: default colors (background #f9fafb, text #1f2937, surface #ffffff)
- `.theme-dark`: dark colors (background #111827, text #f9fafb, surface #1f2937, border #374151)
- `.theme-compact`: smaller spacing (spacing-row 0.25rem, font-size-base 0.875rem)
- `.theme-spacious`: larger spacing (spacing-row 1rem, font-size-base 1.125rem)

Choose a curated color palette for the color picker (define as CSS comment for reference):
Primary blues, purples, pinks, reds, ambers, greens, cyans, indigos - 8 swatch colors.

IMPORTANT: Preserve the existing `@import "tailwindcss"` exactly. Add new content AFTER it.
  </action>
  <verify>
Run `npm run build` - build succeeds without CSS errors.
Verify CSS output contains the theme variables by checking the built CSS.
  </verify>
  <done>
index.css contains @theme directive with CSS variables, 4 theme preset classes (.theme-light, .theme-dark, .theme-compact, .theme-spacious), and the original Tailwind import is preserved.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. configStore.ts uses persist middleware with localStorage
4. Config types are properly exported and used
5. CSS theme variables are defined in @theme directive
6. Theme preset classes exist for all 4 presets
</verification>

<success_criteria>
- useConfigStore is importable and functional with all actions
- Persist middleware saves fieldConfigs, globalTheme, styleOverrides to localStorage key 'api2ui-config'
- Mode and panelOpen are NOT persisted (excluded via partialize)
- Deep merge prevents shallow merge from erasing nested config
- CSS variables are available for runtime theming
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-configuration-system/03-01-SUMMARY.md`
</output>
