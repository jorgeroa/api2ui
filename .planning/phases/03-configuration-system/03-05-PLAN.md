---
phase: 03-configuration-system
plan: 05
type: execute
wave: 5
depends_on: ["03-04"]
files_modified:
  - src/components/config/DraggableField.tsx
  - src/components/config/SortableFieldList.tsx
  - src/components/config/StylePanel.tsx
  - src/components/config/ColorPicker.tsx
  - src/components/config/ThemePresets.tsx
  - src/components/config/ConfigPanel.tsx
  - src/components/renderers/TableRenderer.tsx
  - src/components/renderers/DetailRenderer.tsx
autonomous: false

must_haves:
  truths:
    - "User can drag-and-drop to reorder fields/columns in Configure mode"
    - "Reordered fields persist and render in custom order"
    - "User can select theme presets (light, dark, compact, spacious)"
    - "User can customize individual style properties (colors, fonts, spacing)"
    - "Color picker shows curated swatches plus custom color option"
    - "Style changes apply visually in real-time"
    - "All configurations persist in localStorage across page refresh"
    - "StylePanel has endpoint scope selector: edit global defaults or per-endpoint overrides"
    - "Per-endpoint style overrides take effect when viewing that specific endpoint"
  artifacts:
    - path: "src/components/config/DraggableField.tsx"
      provides: "Sortable field wrapper using dnd-kit useSortable"
      exports: ["DraggableField"]
    - path: "src/components/config/SortableFieldList.tsx"
      provides: "DndContext + SortableContext wrapper for field reordering"
      exports: ["SortableFieldList"]
    - path: "src/components/config/StylePanel.tsx"
      provides: "Panel section for theme presets and granular style controls with endpoint scope selector"
      exports: ["StylePanel"]
    - path: "src/components/config/ColorPicker.tsx"
      provides: "Curated swatch palette plus native color input"
      exports: ["ColorPicker"]
    - path: "src/components/config/ThemePresets.tsx"
      provides: "Theme preset selector grid"
      exports: ["ThemePresets"]
  key_links:
    - from: "src/components/config/SortableFieldList.tsx"
      to: "src/store/configStore.ts"
      via: "reorderFields action on drag end"
      pattern: "reorderFields"
    - from: "src/components/config/StylePanel.tsx"
      to: "src/store/configStore.ts"
      via: "applyTheme, setStyleOverride, setEndpointStyleOverride, and clearEndpointOverrides actions"
      pattern: "applyTheme|setStyleOverride|setEndpointStyleOverride|clearEndpointOverrides"
    - from: "src/components/config/StylePanel.tsx"
      to: "src/store/appStore.ts"
      via: "reads operations list from appStore for endpoint selector options"
      pattern: "useAppStore"
    - from: "src/components/config/ColorPicker.tsx"
      to: "src/store/configStore.ts"
      via: "setStyleOverride or setEndpointStyleOverride for color CSS variables"
      pattern: "setStyleOverride|setEndpointStyleOverride"
---

<objective>
Add drag-and-drop field reordering and full style customization (theme presets, colors, fonts, spacing) with per-endpoint scope selector to complete the configuration system.

Purpose: This delivers CFG-06 (CSS customizable styling) with both global defaults and per-endpoint overrides, and completes the inline editing experience with drag-and-drop reordering. After this plan, all 7 CFG requirements are satisfied.

Output: Drag-and-drop field reordering with dnd-kit, style customization panel with theme presets, color picker, granular controls, and endpoint scope selector for per-endpoint style overrides.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-configuration-system/03-RESEARCH.md
@.planning/phases/03-configuration-system/03-CONTEXT.md
@.planning/phases/03-configuration-system/03-03-SUMMARY.md
@.planning/phases/03-configuration-system/03-04-SUMMARY.md
@src/store/configStore.ts
@src/store/appStore.ts
@src/types/config.ts
@src/components/config/ConfigPanel.tsx
@src/components/renderers/TableRenderer.tsx
@src/components/renderers/DetailRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create drag-and-drop reordering</name>
  <files>src/components/config/DraggableField.tsx, src/components/config/SortableFieldList.tsx, src/components/renderers/TableRenderer.tsx, src/components/renderers/DetailRenderer.tsx</files>
  <action>
First, install dnd-kit: `npm install @dnd-kit/core @dnd-kit/sortable`

**DraggableField.tsx** - Sortable field wrapper:
- Uses `useSortable` hook from @dnd-kit/sortable
- Props: `id: string` (field path), `children: React.ReactNode`, `disabled?: boolean`
- Renders drag handle (6-dot grip icon or pattern) + children
- Handle: `{...attributes} {...listeners}` on the grip icon only (not entire row)
- Apply `CSS.Transform.toString(transform)` and `transition` from useSortable
- Only show drag handle in Configure mode (read mode from configStore)
- IMPORTANT: Do NOT use this component inside DragOverlay. Create a separate `FieldPreview` presentational component for the drag overlay (research pitfall #4).

**SortableFieldList.tsx** - DndContext wrapper:
- Props: `items: string[]` (ordered field paths), `onReorder: (orderedPaths: string[]) => void`, `children: React.ReactNode`
- Set up sensors: PointerSensor + KeyboardSensor with `sortableKeyboardCoordinates`
- Collision detection: closestCenter
- On drag end: compute new order using `arrayMove` from @dnd-kit/sortable, call `onReorder` with new order
- DragOverlay with FieldPreview component (simple presentational version, NOT useSortable component)
- Track active drag item ID in local state for DragOverlay rendering

**TableRenderer.tsx** - Add drag-and-drop for columns:
- In Configure mode: wrap the column header row in SortableFieldList
- Each column header becomes a DraggableField
- On reorder: call `reorderFields(orderedPaths)` from configStore
- Column rendering (body cells) follows the reordered column order from fieldConfigs (already implemented in Plan 03)
- The drag handle appears in the header cell, not body cells

**DetailRenderer.tsx** - Add drag-and-drop for fields:
- In Configure mode: wrap the fields list in SortableFieldList
- Each field row becomes a DraggableField
- On reorder: call `reorderFields(orderedPaths)` from configStore
- Field rendering follows reordered order from fieldConfigs (already implemented in Plan 03)

IMPORTANT: Provide keyboard accessibility. dnd-kit's KeyboardSensor with sortableKeyboardCoordinates handles Space to pick up, Arrow keys to move, Space to drop. Add `screenReaderInstructions` to DndContext (research pitfall #5).
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run build` - build succeeds.
Verify: in Configure mode, drag handle appears on fields. Dragging reorders fields. Order persists after refresh.
  </verify>
  <done>
dnd-kit installed. DraggableField and SortableFieldList components created. TableRenderer columns and DetailRenderer fields are drag-reorderable in Configure mode. Keyboard accessible. Order persists in configStore/localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create style customization panel with theme presets, granular controls, and endpoint scope selector</name>
  <files>src/components/config/ThemePresets.tsx, src/components/config/ColorPicker.tsx, src/components/config/StylePanel.tsx, src/components/config/ConfigPanel.tsx</files>
  <action>
**ThemePresets.tsx** - Theme preset selector:
- Grid of 4 preset cards (2x2): Light, Dark, Compact, Spacious
- Each card: small preview showing color scheme (colored rectangle/swatch), preset name, brief description
- Selected preset has highlighted border
- On click: call `applyTheme(preset)` from configStore
- Read current `globalTheme` from configStore to show selected state

**ColorPicker.tsx** - Curated swatches + native color input:
- Props: `label: string`, `value: string`, `cssVar: string`, `onChange: (color: string) => void`
- Curated palette: 8 colors (blues, purples, pinks, reds, ambers, greens, cyans, indigos):
  `['#3b82f6', '#8b5cf6', '#ec4899', '#ef4444', '#f59e0b', '#10b981', '#06b6d4', '#6366f1']`
- Grid of color swatch buttons (4 per row)
- Each swatch: 32x32 rounded square with the color as background
- Selected swatch has dark border + ring
- Below swatches: "Custom..." label + native `<input type="color">` for any color
- `aria-label` on each swatch: "Select {label} color {hex}"

**StylePanel.tsx** - Full style customization section with endpoint scope:
- **Endpoint scope selector at the top:**
  - Label: "Editing styles for:"
  - Dropdown/select with options:
    - "Global (default)" - edits the global `styleOverrides`
    - One entry per endpoint when an OpenAPI spec with multiple endpoints is loaded
  - Read the operations list from `appStore` (the parsed OpenAPI spec operations). Use operationId or `method path` as the endpoint key (same key format used by configStore's endpointOverrides and ThemeApplier).
  - Only show the endpoint selector when an OpenAPI spec is loaded AND it has 2+ endpoints. If only 1 endpoint or no spec loaded, hide the selector and default to global editing.
  - When "Global (default)" is selected: all color/font/spacing controls read from and write to `styleOverrides` via `setStyleOverride(key, value)`
  - When a specific endpoint is selected: all color/font/spacing controls read from `endpointOverrides[endpoint]` (falling back to global values for display) and write via `setEndpointStyleOverride(endpoint, key, value)`
  - Show a "Clear endpoint overrides" button when an endpoint is selected and has overrides, calling `clearEndpointOverrides(endpoint)`
- Organized in subsections:
  1. **Theme Preset** - renders ThemePresets component (always applies globally)
  2. **Colors** - ColorPicker for each themeable color:
     - Primary color (--color-primary)
     - Secondary color (--color-secondary)
     - Background (--color-background)
     - Text (--color-text)
     - Surface (--color-surface)
     - Border (--color-border)
  3. **Typography** - controls:
     - Font family: dropdown with options (system-ui, Inter, monospace, serif)
     - Base font size: slider or number input (12-20px range)
  4. **Spacing** - controls:
     - Row spacing: slider (0.25rem to 1.5rem)
     - Border radius: slider (0 to 1rem)
- Each control calls the appropriate action based on scope:
  - Global scope: `setStyleOverride(cssVarName, value)`
  - Endpoint scope: `setEndpointStyleOverride(endpoint, cssVarName, value)`
- Read current values: when in endpoint scope, show the endpoint's override value if set, otherwise show the global value (grayed out / with "inherited" indicator)
- "Reset Styles" button: when global, clears all styleOverrides. When endpoint, clears that endpoint's overrides.

**ConfigPanel.tsx** - Wire Style section:
- Replace Style placeholder with StylePanel
- Import StylePanel and render in the Style section
- At this point, all three sections (Fields, Components, Style) are fully wired.

IMPORTANT: Style controls modify CSS variables via the configStore. ThemeApplier (from Plan 02) already applies these to the DOM with endpoint-awareness. The connection is: StylePanel -> configStore -> ThemeApplier -> document.documentElement.style. Verify this chain works end-to-end, including switching between endpoints to see endpoint-specific overrides take effect.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run build` - build succeeds.
Verify: theme presets change page appearance. Color pickers change specific colors. Typography and spacing controls work. Endpoint selector appears with multi-endpoint specs. Endpoint-specific overrides apply when viewing that endpoint. All changes persist after refresh.
  </verify>
  <done>
ThemePresets renders 4 preset options. ColorPicker shows swatches + native input. StylePanel provides full style customization with endpoint scope selector. When editing a specific endpoint, controls write to endpointOverrides. ConfigPanel all three sections are wired. Style changes apply in real-time via ThemeApplier -> CSS variables, including per-endpoint overrides.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete configuration system: Configure/View mode toggle, field visibility, label editing, component type overrides with preview picker, primitive field render modes (URL link/text/image, date relative/absolute), drag-and-drop reordering, theme presets, color/font/spacing customization with per-endpoint scope, localStorage persistence</what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173
2. Fetch an API (e.g., JSONPlaceholder /users or any data URL)
3. Click the gear button in bottom-right corner - should toggle to Configure mode
4. Verify: Visual indicator shows Configure mode is active
5. Click eye icon on a field - should toggle visibility. Switch to View mode - field should be gone
6. Click a field label in Configure mode - should become editable. Change it. View mode shows custom label
7. Click the component type badge - should show preview picker with Table/Cards/List/JSON
8. Select Cards - data should re-render as card grid
9. If data has URL fields: click component badge on a URL field - should show text/link/image options. Select "link" - URL should become clickable
10. If data has date fields: click component badge on a date field - should show absolute/relative options
11. Drag a column header/field to reorder - should snap to new position
12. Open the side panel (Settings button or gear)
13. In Style section: try different theme presets (Light, Dark, Compact, Spacious)
14. Change a color using the color picker - should update immediately
15. If OpenAPI spec loaded with multiple endpoints: verify endpoint scope selector appears in Style section
16. Select a specific endpoint in the scope selector - change a color - verify it only applies when viewing that endpoint
17. Switch back to "Global (default)" - verify global styles are separate from endpoint overrides
18. Refresh the page - all changes should persist (including per-endpoint overrides)
19. Click "Reset All" in panel footer - should revert everything to defaults
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. All 7 CFG requirements satisfied:
   - CFG-01: Configure mode with settings panel and inline editing
   - CFG-02: View mode with clean output, no controls
   - CFG-03: Component type overrides (table/cards/list/json) + primitive render modes (URL, date)
   - CFG-04: Field visibility (hide/show)
   - CFG-05: Field label mapping
   - CFG-06: CSS customizable styling (themes, colors, fonts, spacing) with global + per-endpoint scope
   - CFG-07: localStorage persistence
4. Drag-and-drop accessible with keyboard
5. Per-endpoint style overrides work end-to-end
6. All existing functionality preserved
</verification>

<success_criteria>
- Drag-and-drop reorders fields/columns with visual feedback
- Reordered fields persist and render in custom order in View mode
- Theme presets (light, dark, compact, spacious) change page appearance
- Color picker works with curated swatches and custom color
- Font and spacing controls work
- Endpoint scope selector appears when OpenAPI spec has multiple endpoints
- Per-endpoint style overrides apply only when viewing that endpoint
- Global defaults apply everywhere, endpoint overrides layer on top
- All style changes persist in localStorage
- All 7 CFG requirements are verifiably complete
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/03-configuration-system/03-05-SUMMARY.md`
</output>
