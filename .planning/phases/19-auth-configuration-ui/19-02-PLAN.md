---
phase: 19-auth-configuration-ui
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/components/URLInput.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Lock icon button visible next to the URL input field"
    - "Clicking lock icon toggles the auth panel open/closed below the URL bar"
    - "Auth panel auto-expands when a 401/403 error occurs"
    - "Auth panel auto-collapses after credentials are saved"
    - "Lock icon color reflects current auth state (gray/green/red)"
    - "Auth error shows inline in the auth panel, not in the general error area"
  artifacts:
    - path: "src/components/URLInput.tsx"
      provides: "Lock icon button and AuthPanel integration"
    - path: "src/App.tsx"
      provides: "Auth error detection and panel expansion trigger"
  key_links:
    - from: "src/components/URLInput.tsx"
      to: "src/components/auth/AuthPanel.tsx"
      via: "import and render"
      pattern: "AuthPanel"
    - from: "src/components/URLInput.tsx"
      to: "src/components/auth/LockIcon.tsx"
      via: "import and render in URL bar"
      pattern: "LockIcon"
    - from: "src/components/URLInput.tsx"
      to: "src/store/authStore.ts"
      via: "useAuthStore for status and credentials"
      pattern: "useAuthStore"
    - from: "src/App.tsx"
      to: "src/services/api/errors.ts"
      via: "AuthError detection for auto-expand"
      pattern: "AuthError|kind.*auth"
---

<objective>
Wire the auth panel into the URL input area and add auth error auto-expansion behavior. The lock icon appears next to the Fetch button, and the collapsible auth panel renders below the URL bar.

Purpose: This connects the auth UI components (Plan 01) to the main application flow, making authentication configuration accessible to users and responsive to auth errors.

Output: Modified URLInput.tsx with integrated lock icon and auth panel, modified App.tsx with auth error detection for panel auto-expansion.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-auth-configuration-ui/19-CONTEXT.md
@.planning/phases/19-auth-configuration-ui/19-01-SUMMARY.md
@src/components/URLInput.tsx
@src/App.tsx
@src/store/authStore.ts
@src/services/api/errors.ts
@src/components/auth/AuthPanel.tsx
@src/components/auth/LockIcon.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate LockIcon and AuthPanel into URLInput</name>
  <files>
    src/components/URLInput.tsx
    src/App.tsx
  </files>
  <action>
**Modify URLInput.tsx:**

1. Add imports: `LockIcon` from `./auth/LockIcon`, `AuthPanel` from `./auth/AuthPanel`, `useAuthStore` from `../store/authStore`.

2. Add auth state management inside URLInput component:
   - `const [authPanelOpen, setAuthPanelOpen] = useState(false)`
   - Read auth state: `const { getAuthStatus, getCredentials } = useAuthStore()`
   - Derive lock status from `getAuthStatus(url)` mapping: `'untested'` with active credential -> `'active'`, `'success'` -> `'active'`, `'failed'` -> `'failed'`, no credentials -> `'none'` (use `getCredentials(url)?.activeType` to check if any credential is configured)
   - Derive active type from `getCredentials(url)?.activeType`

3. Add LockIcon button in the URL input row, between the text input and the Fetch button:
   ```tsx
   <div className="flex gap-2">
     <input ... />
     <LockIcon
       status={lockStatus}
       activeType={activeType}
       onClick={() => setAuthPanelOpen(!authPanelOpen)}
     />
     <button type="submit" ...>Fetch</button>
   </div>
   ```

4. Add AuthPanel below the URL form, above the validation error:
   ```tsx
   <AuthPanel
     url={url}
     isOpen={authPanelOpen}
     onToggle={() => setAuthPanelOpen(!authPanelOpen)}
   />
   ```

5. Add an `authError` prop to URLInput: `{ authError?: { status: 401 | 403; message: string } | null }`. Pass it through to AuthPanel.

6. Add an effect that auto-expands the panel when `authError` changes to a non-null value:
   ```tsx
   useEffect(() => {
     if (authError) {
       setAuthPanelOpen(true)
     }
   }, [authError])
   ```

**Modify App.tsx:**

1. Import `AuthError` from `./services/api/errors`.

2. Derive `authError` from the `error` state in appStore. Check if the error is an AuthError (has `kind === 'auth'` and `status` property):
   ```tsx
   const authError = error && 'kind' in error && (error as any).kind === 'auth'
     ? { status: (error as any).status as 401 | 403, message: error.message }
     : null
   ```

3. Pass `authError` to both URLInput instances (sidebar layout and centered layout):
   ```tsx
   <URLInput authError={authError} />
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors. Run `npm run build` — build succeeds. Run `npm test` — all existing tests pass (no regressions).
  </verify>
  <done>
Lock icon visible next to URL input. Clicking toggles auth panel. Auth panel renders below URL bar with type selector and credential form. Panel auto-expands on 401/403 errors. Lock icon reflects auth state with correct color.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete auth configuration UI: lock icon near URL input, collapsible auth panel with type selector, dynamic credential forms with masked inputs, and auth error auto-expansion.
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173
2. Verify lock icon (gray, open lock) appears between URL input and Fetch button
3. Click the lock icon — auth panel should expand below URL bar
4. Select "Bearer Token" from dropdown — token input field should appear (masked)
5. Type a token value — eye icon should toggle visibility
6. Select "Basic Auth" — username + password fields should appear
7. Select "API Key" — header name + value fields should appear
8. Select "Query Parameter" — param name + value fields should appear
9. Select "None" — fields should disappear, credentials cleared
10. Enter a URL that returns 401 (e.g., https://httpstat.us/401) — auth panel should auto-expand with error message
11. Verify lock icon turns red on auth error
12. Configure Bearer Token credentials, lock icon should turn green
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `npm test` passes (no regressions)
4. Lock icon visible in URL input area
5. Auth panel expands/collapses on lock icon click
6. Auth type selector works for all 5 options
7. Credential forms render correct fields per type
8. Auth errors trigger panel auto-expansion
</verification>

<success_criteria>
Auth configuration UI fully integrated into the application. Lock icon near URL input shows auth state. Clicking opens collapsible panel with type selector and credential forms. 401/403 errors auto-expand panel with contextual messages. Selecting "None" clears credentials. All credential inputs masked with visibility toggle. No regressions in existing tests or build.
</success_criteria>

<output>
After completion, create `.planning/phases/19-auth-configuration-ui/19-02-SUMMARY.md`
</output>
