---
phase: 05-smart-visual-defaults
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/imageDetection.ts
  - src/components/renderers/PrimitiveRenderer.tsx
autonomous: true

must_haves:
  truths:
    - "URL fields ending in image extensions (.jpg, .png, .gif, .webp, .svg, .avif) render as <img> by default"
    - "User overrides (componentType='text' or 'link') still take precedence over auto-detection"
    - "Broken image URLs gracefully fall back to text display"
  artifacts:
    - path: "src/utils/imageDetection.ts"
      provides: "isImageUrl utility function"
      exports: ["isImageUrl"]
    - path: "src/components/renderers/PrimitiveRenderer.tsx"
      provides: "Auto-image detection in URL rendering path"
      contains: "isImageUrl"
  key_links:
    - from: "src/components/renderers/PrimitiveRenderer.tsx"
      to: "src/utils/imageDetection.ts"
      via: "import { isImageUrl }"
      pattern: "import.*isImageUrl.*imageDetection"
---

<objective>
Create the `isImageUrl` utility and integrate it into PrimitiveRenderer so that URL fields with image extensions automatically render as `<img>` elements without any user configuration.

Purpose: This is the foundation for all visual intelligence in Phase 5 — every other plan depends on this image detection utility.
Output: A reusable `isImageUrl()` function and enhanced PrimitiveRenderer that auto-renders image URLs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/renderers/PrimitiveRenderer.tsx
@src/store/configStore.ts
@src/types/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create isImageUrl utility</name>
  <files>src/utils/imageDetection.ts</files>
  <action>
Create `src/utils/imageDetection.ts` with a single exported function `isImageUrl(value: string): boolean`.

Implementation:
1. Return `false` if value is falsy, not a string, or doesn't match `^https?:\/\/`
2. Parse the URL using `new URL(value)` and extract `.pathname`
3. Check if pathname ends with any of: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`, `.svg`, `.avif` (case-insensitive via `.toLowerCase()`)
4. Wrap the `new URL()` call in try/catch — on parse failure, fall back to checking the raw lowercase string for extensions (before any `?` character)
5. Do NOT check query parameters or CDN domains — keep detection simple and high-confidence

The function must:
- Use `new URL(value).pathname` to avoid false positives from query params (Pitfall 1 from research)
- Be a pure function with no side effects
- Handle edge cases: empty string, non-URL strings, URLs without extensions
  </action>
  <verify>
Create a quick mental check: `isImageUrl("https://example.com/photo.jpg")` returns true, `isImageUrl("https://api.com/data?format=.jpg")` returns false, `isImageUrl("not a url")` returns false, `isImageUrl("https://example.com/page")` returns false.
  </verify>
  <done>isImageUrl correctly identifies URLs with image file extensions in the pathname, ignoring query parameters</done>
</task>

<task type="auto">
  <name>Task 2: Integrate auto-image detection into PrimitiveRenderer</name>
  <files>src/components/renderers/PrimitiveRenderer.tsx</files>
  <action>
Modify `src/components/renderers/PrimitiveRenderer.tsx` to auto-detect image URLs:

1. Add import: `import { isImageUrl } from '../../utils/imageDetection'`

2. In the URL handling block (currently at line 128, inside `if (isURL(data))`), change the rendering logic:
   - Currently: only renders as image when `renderMode === 'image'`
   - New behavior: render as image when `isImageUrl(data) && renderMode !== 'link' && renderMode !== 'text'` OR when `renderMode === 'image'`
   - This means: auto-detect defaults to image for image URLs, but user overrides to 'text' or 'link' are respected

3. Specifically, after line 141 (end of `renderMode === 'link'` block), add the auto-detection:
   ```
   // Auto-detect image URLs — render as image by default
   const shouldAutoImage = isImageUrl(data) && renderMode !== 'text'
   if (shouldAutoImage || renderMode === 'image') {
     // existing image rendering code (lines 143-155)
   }
   ```

4. Add `loading="lazy"` to the img tag for performance
5. Keep the existing `imageError` state and error fallback behavior
6. Also update `getAvailableRenderModes`: the function already returns `['text', 'link', 'image']` for URLs — this is correct, no change needed.

Critical: The `renderMode === 'link'` check MUST come before the auto-image check, so explicitly set links still work. The order is: explicit link -> auto-image/explicit image -> default text.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Visually verify: load an API with image URLs (e.g., a Pokemon API or similar), confirm images render automatically.
  </verify>
  <done>PrimitiveRenderer auto-renders image URLs as img elements, respects user overrides, and uses lazy loading</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. Image URLs (e.g., "https://example.com/photo.jpg") auto-render as `<img>` tags
4. Non-image URLs still render as truncated text by default
5. User override to 'text' or 'link' takes precedence over auto-detection
6. Broken image URLs show text fallback (existing imageError behavior)
</verification>

<success_criteria>
- isImageUrl utility exists and correctly detects image URLs by file extension
- PrimitiveRenderer auto-renders image URLs without requiring user configuration
- Existing render mode overrides (text, link, image) still work correctly
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-smart-visual-defaults/05-01-SUMMARY.md`
</output>
